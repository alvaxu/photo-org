

/**
 * ÂÆ∂Â∫≠ÂçïÊú∫ÁâàÊô∫ËÉΩÁÖßÁâáÊï¥ÁêÜÁ≥ªÁªü - ‰∏ªÂ∫îÁî®ËÑöÊú¨
 */

// Ê≥®ÊÑèÔºöCONFIG, AppState, searchTypePlaceholders, searchScopeHints Â∑≤ÁßªËá≥ app-data.js

// DOM ÂÖÉÁ¥†ÁºìÂ≠ò
let elements = {};

// ÂàùÂßãÂåñÂ∫îÁî®
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

// Ê≥®ÊÑèÔºöloadHotData ÂáΩÊï∞Â∑≤ÁßªËá≥ app-data.js

function initializeApp() {
    console.log('üöÄ ÂàùÂßãÂåñÂÆ∂Â∫≠ÂçïÊú∫ÁâàÊô∫ËÉΩÁÖßÁâáÊï¥ÁêÜÁ≥ªÁªü');

    // ÁºìÂ≠òDOMÂÖÉÁ¥†
    cacheElements();

    // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
    bindEvents();

    // ÂàùÂßãÂåñUIÁªÑ‰ª∂
    initializeUI();
    
    // Âä†ËΩΩÁÉ≠Èó®Êï∞ÊçÆ
    loadHotData();

    // Âä†ËΩΩÂàùÂßãÊï∞ÊçÆ
    loadInitialData();

    // ËÆæÁΩÆÂÆöÊúüÂà∑Êñ∞
    setupAutoRefresh();
}

function cacheElements() {
    console.log('üìã ÁºìÂ≠òDOMÂÖÉÁ¥†');

    elements = {
        // ÂØºËà™
        navPhotos: document.getElementById('navPhotos'),

        // Êìç‰ΩúÊåâÈíÆ
        importBtn: document.getElementById('importBtn'),
        batchBtn: document.getElementById('batchBtn'),

        // ÊêúÁ¥¢ÂíåÁ≠õÈÄâ
        searchInput: document.getElementById('searchInput'),
        searchBtn: document.getElementById('searchBtn'),
    searchType: document.getElementById('searchType'),
    searchScopeHint: document.getElementById('searchScopeHint'),
    searchSuggestions: document.getElementById('searchSuggestions'),
        dateFilter: document.getElementById('dateFilter'),
        customDateRange: document.getElementById('customDateRange'),
        startDate: document.getElementById('startDate'),
        endDate: document.getElementById('endDate'),
        qualityFilter: document.getElementById('qualityFilter'),
        sortBy: document.getElementById('sortBy'),
        sortOrder: document.getElementById('sortOrder'),
        clearFilters: document.getElementById('clearFilters'),
        clearFiltersSmall: document.getElementById('clearFiltersSmall'),
        filterStatus: document.getElementById('filterStatus'),
        filterStatusText: document.getElementById('filterStatusText'),

        // ËßÜÂõæÂàáÊç¢
        gridView: document.getElementById('gridView'),
        listView: document.getElementById('listView'),

        // ÁªüËÆ°‰ø°ÊÅØ
        statsRow: document.getElementById('statsRow'),

        // ÁÖßÁâáÂå∫Âüü
        photoCount: document.getElementById('photoCount'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        emptyState: document.getElementById('emptyState'),
        photosGrid: document.getElementById('photosGrid'),
        paginationContainer: document.getElementById('paginationContainer'),
        pagination: document.getElementById('pagination'),

        // ÈÄâÊã©Êìç‰Ωú
        selectAllBtn: document.getElementById('selectAllBtn'),
        clearSelectionBtn: document.getElementById('clearSelectionBtn'),
        deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),

        // Ê®°ÊÄÅÊ°Ü
        photoModal: document.getElementById('photoModal'),
        importModal: document.getElementById('importModal'),
        batchModal: document.getElementById('batchModal'),

        // ÂØºÂÖ•Áõ∏ÂÖ≥
        photoFiles: document.getElementById('photoFiles'),
        startImportBtn: document.getElementById('startImportBtn'),
        importFirstBtn: document.getElementById('importFirstBtn'),
        importProgress: document.getElementById('importProgress'),
        importProgressBar: document.getElementById('importProgressBar'),
        importStatus: document.getElementById('importStatus'),
        
        // ÂØºÂÖ•ÊñπÂºèÂàáÊç¢
        fileImport: document.getElementById('fileImport'),
        folderImport: document.getElementById('folderImport'),
        fileImportSection: document.getElementById('fileImportSection'),
        folderImportSection: document.getElementById('folderImportSection'),
        folderPath: document.getElementById('folderPath'),
        browseFolderBtn: document.getElementById('browseFolderBtn'),
        recursiveScan: document.getElementById('recursiveScan'),

        // ÊâπÈáèÂ§ÑÁêÜÁõ∏ÂÖ≥
        startBatchBtn: document.getElementById('startBatchBtn'),
        batchProgress: document.getElementById('batchProgress'),
        batchProgressBar: document.getElementById('batchProgressBar'),
        batchStatus: document.getElementById('batchStatus')
    };
}

function bindEvents() {
    console.log('üîó ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®');

    // Á°Æ‰øù elements ÂØπË±°Âú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂèØÁî®
    window.elements = elements;

    // ÁªëÂÆöÂü∫Á°Ä‰∫ã‰ª∂ÔºàÂØºËà™„ÄÅÂØºÂÖ•„ÄÅÈÄâÊã©Êìç‰ΩúÁ≠âÔºâ
    bindBasicEvents();

    // ÊêúÁ¥¢‰∫ã‰ª∂
    elements.searchInput.addEventListener('input', debounce(handleSearch, CONFIG.DEBOUNCE_DELAY));
    elements.searchBtn.addEventListener('click', handleSearch);
    elements.searchType.addEventListener('change', handleSearchTypeChange);
    elements.dateFilter.addEventListener('change', handleDateFilterChange);
    elements.qualityFilter.addEventListener('change', handleFilterChange);
    elements.sortBy.addEventListener('change', handleSortChange);
    elements.sortOrder.addEventListener('change', handleSortChange);
    elements.startDate.addEventListener('change', handleCustomDateChange);
    elements.endDate.addEventListener('change', handleCustomDateChange);
    elements.clearFilters.addEventListener('click', clearAllFilters);
    elements.clearFiltersSmall.addEventListener('click', clearAllFilters);

    // ËßÜÂõæÂàáÊç¢‰∫ã‰ª∂
    elements.gridView.addEventListener('change', () => switchView('grid'));
    elements.listView.addEventListener('change', () => switchView('list'));
}

// Ê≥®ÊÑèÔºöinitializeUI ÂáΩÊï∞Â∑≤ÁßªËá≥ app-ui.js

function loadInitialData() {
    console.log('üìä Âä†ËΩΩÂàùÂßãÊï∞ÊçÆ');

    // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
    loadStats();

    // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µÁÖßÁâá
    loadPhotos(1);
}

function setupAutoRefresh() {
    // ÊØè5ÂàÜÈíüËá™Âä®Âà∑Êñ∞ÁªüËÆ°‰ø°ÊÅØ
    setInterval(() => {
        loadStats();
    }, 5 * 60 * 1000);
}

// Ê≥®ÊÑèÔºöÊêúÁ¥¢ÂíåÁ≠õÈÄâÂáΩÊï∞Â∑≤ÁßªËá≥ app-data.js

// Ê≥®ÊÑèÔºöswitchView, showImportModal, showBatchModal ÂáΩÊï∞Â∑≤ÁßªËá≥ app-ui.js

// Ê≥®ÊÑèÔºöhandleFileSelection ÂáΩÊï∞Â∑≤ÁßªËá≥ app-events.js

// Ê≥®ÊÑèÔºöhandleKeyboard ÂáΩÊï∞Â∑≤ÁßªËá≥ app-events.js

// Ê≥®ÊÑèÔºöÊï∞ÊçÆÂä†ËΩΩÂáΩÊï∞ loadStats, loadPhotos Â∑≤ÁßªËá≥ app-data.js

// Ê≥®ÊÑèÔºöÊ∏≤ÊüìÂáΩÊï∞Â∑≤ÁßªËá≥ app-data.js

// Ê≥®ÊÑèÔºörenderPhotos, renderGridView, renderListView Â∑≤ÁßªËá≥ app-data.js

// Ê≥®ÊÑèÔºöcreatePhotoCard ÂáΩÊï∞Â∑≤ÁßªËá≥ app-photos.js

function createPhotoListItem(photo) {
    const allTags = photo.tags || [];
    const visibleTags = allTags.slice(0, 5);
    const hiddenTagsCount = allTags.length - 5;
    
    const visibleTagsHtml = visibleTags.map(tag =>
        `<span class="badge bg-secondary me-1 mb-1">${tag}</span>`
    ).join('');
    
    const hiddenTagsHtml = allTags.slice(5).map(tag =>
        `<span class="badge bg-secondary me-1 mb-1">${tag}</span>`
    ).join('');

    const qualityClass = getQualityClass(photo.quality?.level || '');
    const qualityText = getQualityText(photo.quality?.level || '');

    // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
    const formatFileSize = (bytes) => {
        if (!bytes) return 'Êú™Áü•';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size.toFixed(1)} ${units[unitIndex]}`;
    };

    // Ê†ºÂºèÂåñÂàÜËæ®Áéá
    const resolution = photo.width && photo.height ? `${photo.width} √ó ${photo.height}` : 'Êú™Áü•';

    return `
        <div class="photo-list-item" data-photo-id="${photo.id}">
            <div class="photo-thumbnail-container">
                <img src="/${(photo.thumbnail_path || CONFIG.IMAGE_PLACEHOLDER).replace(/\\/g, '/')}"
                     alt="${photo.filename}"
                     class="photo-thumbnail">
                <div class="photo-overlay">
                    <i class="bi bi-eye text-white"></i>
                </div>
            </div>
            <div class="photo-details">
                <div class="photo-header">
                    <div class="photo-title">${photo.filename}</div>
                    <div class="photo-actions">
                        <span class="badge ${qualityClass}">${qualityText}</span>
                    </div>
                </div>
                <div class="photo-meta">
                    <div class="meta-row">
                        <span class="meta-item">
                            <i class="bi bi-calendar me-1"></i>
                            ${formatDate(photo.taken_at)} (ÊãçÊëÑÊó•Êúü)
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-geo-alt me-1"></i>
                            ${photo.location_name || 'Êú™Áü•‰ΩçÁΩÆ'}
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-camera me-1"></i>
                            ${photo.camera_make || 'Êú™Áü•'} ${photo.camera_model || ''}
                        </span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-item">
                            <i class="bi bi-image me-1"></i>
                            ${resolution}
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-file-earmark me-1"></i>
                            ${formatFileSize(photo.file_size)}
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-clock me-1"></i>
                            ${formatDateTime(photo.created_at)}
                        </span>
                    </div>
                </div>
                <div class="photo-description">
                    ${photo.analysis?.description || 'ÊöÇÊó†ÊèèËø∞'}
                </div>
                <div class="photo-tags">
                    <div class="visible-tags">
                        ${visibleTagsHtml}
                    </div>
                    ${hiddenTagsCount > 0 ? `
                        <div class="hidden-tags" style="display: none;">
                            ${hiddenTagsHtml}
                        </div>
                        <span class="tag-toggle" onclick="toggleTags(this, event)" data-photo-id="${photo.id}">
                            +${hiddenTagsCount} Êõ¥Â§ö
                        </span>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Ê≥®ÊÑèÔºörenderPagination Â∑≤ÁßªËá≥ app-data.js

// Ê≥®ÊÑèÔºöshowPhotoDetail, createPhotoDetailModal ÂáΩÊï∞Â∑≤ÁßªËá≥ app-ui.js

// ============ ÂØºÂÖ•ÂäüËÉΩ ============

// Ê≥®ÊÑèÔºöÊâÄÊúâÂØºÂÖ•Áõ∏ÂÖ≥ÂáΩÊï∞Â∑≤ÁßªËá≥ app-import.js

// ============ ÊâπÈáèÂ§ÑÁêÜÂäüËÉΩ ============

// Ê≥®ÊÑèÔºöstartBatchProcess ÂáΩÊï∞Â∑≤ÁßªËá≥ app-import.js

// Ê≥®ÊÑèÔºöstartFolderImport ÂáΩÊï∞Â∑≤ÁßªËá≥ app-import.js

// Ê≥®ÊÑèÔºömonitorScanProgress ÂáΩÊï∞Â∑≤ÁßªËá≥ app-import.js

// Ê≥®ÊÑèÔºöstartBatchProcess ÂáΩÊï∞Â∑≤ÁßªËá≥ app-import.js

// Ê≥®ÊÑèÔºöselectAllPhotos, clearSelection, deleteSelectedPhotos ÂáΩÊï∞Â∑≤ÁßªËá≥ app-photos.js
// Ê≥®ÊÑèÔºöswitchSection, updateNavigation, showPhotosSection ÂáΩÊï∞Â∑≤ÁßªËá≥ app-photos.js


// Ê≥®ÊÑèÔºötoggleTags ÂáΩÊï∞Â∑≤ÁßªËá≥ app-ui.js

// ============ ÂÖ®Â±ÄÂØºÂá∫ ============

window.PhotoApp = {
    loadPhotos,
    loadStats,
    showError
};

window.toggleTags = toggleTags;
window.selectSuggestion = selectSuggestion;
