<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>系统配置 - 家庭版智能照片系统</title>

    <!-- Bootstrap CSS - 优先使用本地版本 -->
    <link href="/static/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/lib/bootstrap-icons/css/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons 字体修复 -->
    <style>
        @font-face {
            font-display: block;
            font-family: "bootstrap-icons";
            src: url("/static/lib/bootstrap-icons/fonts/bootstrap-icons.woff2?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff2"),
                 url("/static/lib/bootstrap-icons/fonts/bootstrap-icons.woff?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff");
        }
    </style>
    
    <!-- CDN备用加载 -->
    <script>
        // 如果本地资源加载失败，尝试CDN
        setTimeout(function() {
            const links = document.querySelectorAll('link[href*="/static/lib/"]');
            links.forEach(link => {
                if (!link.sheet) {
                    console.warn('本地资源加载失败，尝试CDN:', link.href);
                    if (link.href.includes('bootstrap.min.css')) {
                        link.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css';
                    } else if (link.href.includes('bootstrap-icons.min.css')) {
                        link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
                    }
                }
            });
        }, 2000);
    </script>

    <!-- 自定义样式 -->
    <link href="/static/css/style.css?v=20250119_80" rel="stylesheet">
    <link href="/static/css/settings.css?v=20250119_80" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="/static/images/xuwh.ico" alt="智能照片系统" class="me-2" style="width: 32px; height: 32px;">
                智能照片系统
                <small class="ms-2 text-light opacity-75">2025-V6版</small>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../static/index.html" id="navPhotos" data-section="photos">
                            <i class="bi bi-grid-3x3-gap"></i> 照片库
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="navSettings" data-section="settings">
                            <i class="bi bi-gear"></i> 系统配置
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/help-overview" id="navHelp" data-section="help">
                            <i class="bi bi-info-circle"></i> 功能说明
                        </a>
                    </li>
                </ul>

                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" id="resetConfigBtn">
                        <i class="bi bi-arrow-clockwise"></i> 重置为默认
                    </button>
                    <button class="btn btn-outline-light me-2" id="exportConfigBtn">
                        <i class="bi bi-download"></i> 导出配置
                    </button>
                    <button class="btn btn-outline-light" id="saveConfigBtn">
                        <i class="bi bi-check-lg"></i> 保存配置
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="container-fluid mt-4">

        <!-- 配置表单 -->
        <form id="userConfigForm">
            <div class="row">
                <!-- AI服务设置 -->
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-robot me-2"></i>
                                AI服务设置
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="mb-2">
                                <label for="aiModel" class="form-label small">大模型选择</label>
                                <select class="form-select form-select-sm" id="aiModel">
                                    <!-- 选项将通过JavaScript动态加载 -->
                                </select>
                                <div class="form-text small">
                                    选择用于图像分析的AI模型<br>
                                    <span class="text-muted">当前值: <span id="aiModelCurrent">加载中...</span></span><br>
                                    <span class="text-muted">默认值: <span id="aiModelDefault">加载中...</span></span>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="apiKey" class="form-label small">API密钥</label>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="apiKey"
                                           placeholder="留空则使用环境变量">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleApiKeyVisibility">
                                        <i class="bi bi-eye-slash" id="apiKeyIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text small">
                                    优先使用环境变量 DASHSCOPE_API_KEY<br>
                                    <span class="text-muted">当前值: <span id="apiKeyCurrent">已设置</span></span><br>
                                    <span class="text-muted">默认值: <span id="apiKeyDefault">加载中...</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 存储设置 -->
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-folder me-2"></i>
                                存储设置
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <!-- 远程访问提示 - 存储目录配置已移除 -->
                            <div class="row mb-3" id="remoteAccessNotice" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-info alert-sm py-2 px-3">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>存储目录配置：</strong>此配置项仅限本地访问，远程访问时不可见。如需修改存储目录，请在主机端打开配置页面。
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 照片大小限制设置 -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="maxFileSize" class="form-label small">照片大小限制</label>
                                    <select class="form-select form-select-sm" id="maxFileSize">
                                        <option value="26214400">25MB</option>
                                        <option value="52428800" selected>50MB</option>
                                        <option value="104857600">100MB</option>
                                        <option value="209715200">200MB</option>
                                    </select>
                                    <div class="form-text small">
                                        <span class="text-muted">当前值: <span id="maxFileSizeCurrent">50MB</span></span><br>
                                        <span class="text-muted">默认值: <span id="maxFileSizeDefault">加载中...</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 文件路径设置 - 已移除，用户不可配置 -->
                            <div class="row mb-3" id="storagePathSection" style="display: none;">
                                <div class="col-12">
                                    <label for="photosPath" class="form-label small">照片存储目录</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="photosPath"
                                               value="./photos_storage">
                                        <button class="btn btn-outline-secondary" type="button" id="selectPhotosPath">
                                            <i class="bi bi-folder"></i>
                                        </button>
                                    </div>
                                    <div class="form-text small">
                                        照片文件的存储位置（点击文件夹图标选择目录）<br>
                                        <div class="alert alert-warning alert-sm py-1 px-2 mt-2 mb-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <strong>重要提醒：</strong>更改存储目录前，请先将原目录下的所有照片数据复制到新目录，否则原有照片将无法找到，数据库信息也会失效！更改后请立即重启服务！
                                        </div>
                                        <span class="text-muted">当前值: <span id="photosPathCurrent">./photos_storage</span></span><br>
                                        <span class="text-muted">默认值: <span id="photosPathDefault">加载中...</span></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 缩略图设置 - 一行两列 -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label for="thumbnailQuality" class="form-label small">缩略图质量</label>
                                    <input type="range" class="form-range" id="thumbnailQuality" 
                                           min="1" max="100" value="85">
                                    <div class="d-flex justify-content-between">
                                        <small>1%</small>
                                        <small id="thumbnailQualityValue">85%</small>
                                        <small>100%</small>
                                    </div>
                                    <div class="form-text small">
                                        <span class="text-muted">当前值: <span id="thumbnailQualityCurrent">85%</span></span><br>
                                        <span class="text-muted">默认值: <span id="thumbnailQualityDefault">加载中...</span></span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label for="thumbnailSize" class="form-label small">缩略图尺寸</label>
                                    <input type="range" class="form-range" id="thumbnailSize" 
                                           min="100" max="1000" value="300">
                                    <div class="d-flex justify-content-between">
                                        <small>100px</small>
                                        <small id="thumbnailSizeValue">300px</small>
                                        <small>1000px</small>
                                    </div>
                                    <div class="form-text small">
                                        <span class="text-muted">当前值: <span id="thumbnailSizeCurrent">300px</span></span><br>
                                        <span class="text-muted">默认值: <span id="thumbnailSizeDefault">加载中...</span></span>
                                    </div>
                                </div>
                            </div>
                            <!-- 照片大小限制已移到照片存储目录同一行 -->
                        </div>
                    </div>
                </div>
                
                <!-- 地址解析设置 - 第二行左边 -->
                <div class="col-lg-6 mb-3">
                    <div class="card">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-geo-alt me-2"></i>
                                地址解析设置
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="mb-2">
                                <label for="defaultGeocodingService" class="form-label small">默认地址解析服务</label>
                                <select class="form-select form-select-sm" id="defaultGeocodingService">
                                    <option value="ask">每次都询问</option>
                                    <option value="amap">高德地图API (推荐)</option>
                                    <option value="offline">离线数据库</option>
                                    <option value="nominatim">Nominatim API (需科学上网)</option>
                                </select>
                                <div class="form-text small">
                                    <span class="text-muted">选择默认使用的地址解析服务</span>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label for="amapApiKey" class="form-label small">高德地图API密钥</label>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="amapApiKey" placeholder="请输入API密钥">
                                    <button class="btn btn-outline-secondary" type="button" id="testAmapApi">
                                        <i class="bi bi-check-circle"></i> 测试
                                    </button>
                                </div>
                                <div class="form-text small">
                                    <span class="text-muted">用于国内地址解析，提高准确性</span>
                                    <br>
                                    <span class="text-info">当前值: <span id="amapApiKeyCurrent">未设置</span></span>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label small">服务说明</label>
                                <div class="service-comparison">
                                    <div class="row">
                                        <div class="col-4">
                                            <div class="service-info p-2 border rounded">
                                                <h6 class="mb-1">🌐 高德地图API</h6>
                                                <ul class="small mb-0">
                                                    <li>国内地址详细准确</li>
                                                    <li>支持中文地址</li>
                                                    <li>需要网络连接</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="service-info p-2 border rounded">
                                                <h6 class="mb-1">🏠 离线数据库</h6>
                                                <ul class="small mb-0">
                                                    <li>无需网络连接</li>
                                                    <li>全球主要城市</li>
                                                    <li>地址信息相对简单</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="service-info p-2 border rounded">
                                                <h6 class="mb-1">🌍 Nominatim API</h6>
                                                <ul class="small mb-0">
                                                    <li>全球地址覆盖</li>
                                                    <li>免费无需API密钥</li>
                                                    <li><span class="text-warning">需要科学上网</span></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 第二行右边：界面设置和搜索设置 -->
                <div class="col-lg-6 mb-3">
                    <!-- 搜索设置 -->
                    <div class="card">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-search me-2"></i>
                                搜索设置
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <!-- 默认相似照片搜索方式 -->
                            <div class="mb-2">
                                <label for="defaultSimilarPhotoSearch" class="form-label small">默认相似照片搜索方式</label>
                                <select class="form-select form-select-sm" id="defaultSimilarPhotoSearch">
                                    <option value="ask" selected>每次都询问</option>
                                    <option value="features">特征向量搜索</option>
                                    <option value="enhanced">智能分析相似搜索</option>
                                </select>
                                <div class="form-text small">
                                    <span class="text-muted">选择默认使用的相似照片搜索方式</span><br>
                                    <span class="text-muted">• 特征向量搜索：基于ResNet50深度特征，精度高，通过匹配聚类来匹配相似照片（需要先运行“相似照识别”中的特征提取和开始聚类）</span><br>
                                    <span class="text-muted">• 智能分析相似搜索：更适用于AI分析后，综合多种特征，结果更全面</span><br>
                                </div>
                            </div>
                            
                            <!-- 搜索设置 - 一行三列 -->
                            <div class="row">
                                <div class="col-4">
                                    <label for="featuresSimilarityThreshold" class="form-label small">特征向量搜索相似度阈值</label>
                                    <input type="range" class="form-range" id="featuresSimilarityThreshold" 
                                           min="0" max="1" step="0.05" value="0.75">
                                    <div class="d-flex justify-content-between">
                                        <small>0.0 (宽松)</small>
                                        <small id="featuresSimilarityThresholdValue">0.75</small>
                                        <small>1.0 (严格)</small>
                                    </div>
                                    <div class="form-text small">
                                        用于特征向量搜索的阈值<br>
                                        <span class="text-muted">当前值: <span id="featuresSimilarityThresholdCurrent">0.75</span></span><br>
                                        <span class="text-muted">默认值: <span id="featuresSimilarityThresholdDefault">加载中...</span></span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label for="similarityThreshold" class="form-label small">智能分析相似度阈值</label>
                                    <input type="range" class="form-range" id="similarityThreshold" 
                                           min="0" max="1" step="0.05" value="0.8">
                                    <div class="d-flex justify-content-between">
                                        <small>0.0 (宽松)</small>
                                        <small id="similarityThresholdValue">0.8</small>
                                        <small>1.0 (严格)</small>
                                    </div>
                                    <div class="form-text small">
                                        用于智能分析相似搜索的阈值<br>
                                        <span class="text-muted">当前值: <span id="similarityThresholdCurrent">0.8</span></span><br>
                                        <span class="text-muted">默认值: <span id="similarityThresholdDefault">加载中...</span></span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label for="duplicateThreshold" class="form-label small">重复检测阈值</label>
                                    <input type="range" class="form-range" id="duplicateThreshold" 
                                           min="1" max="20" value="5">
                                    <div class="d-flex justify-content-between">
                                        <small>1 (严格)</small>
                                        <small id="duplicateThresholdValue">5</small>
                                        <small>20 (宽松)</small>
                                    </div>
                                    <div class="form-text small">
                                        用于重复照片检测的阈值<br>
                                        <span class="text-muted">当前值: <span id="duplicateThresholdCurrent">5</span></span><br>
                                        <span class="text-muted">默认值: <span id="duplicateThresholdDefault">加载中...</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 界面设置 -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-display me-2"></i>
                                界面设置
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label for="photosPerPage" class="form-label small">每页显示照片数</label>
                                        <select class="form-select form-select-sm" id="photosPerPage">
                                            <option value="6">6张</option>
                                            <option value="12" selected>12张</option>
                                            <option value="18">18张</option>
                                            <option value="24">24张</option>
                                            <option value="30">30张</option>
                                        </select>
                                        <div class="form-text small">
                                            <span class="text-muted">当前值: <span id="photosPerPageCurrent">12张</span></span><br>
                                            <span class="text-muted">默认值: <span id="photosPerPageDefault">加载中...</span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label for="similarPhotosLimit" class="form-label small">相似照片显示数量</label>
                                        <select class="form-select form-select-sm" id="similarPhotosLimit">
                                            <option value="4">4张</option>
                                            <option value="8" selected>8张</option>
                                            <option value="12">12张</option>
                                        </select>
                                        <div class="form-text small">
                                            <span class="text-muted">当前值: <span id="similarPhotosLimitCurrent">8张</span></span><br>
                                            <span class="text-muted">默认值: <span id="similarPhotosLimitDefault">加载中...</span></span>
                                        </div>
                                    </div>
                            </div>
                            <!-- 热门标签和分类配置已移除，因为前端没有实际使用这些数据 -->
                        </div>
                    </div>                 
                </div>
                </div>
            </div>
        </form>

        <!-- 配置状态提示 -->
        <div class="row">
            <div class="col-12">
                <div id="configStatus" class="alert alert-info d-none">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="configStatusText">配置已保存</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 配置确认模态框 -->
    <div class="modal fade" id="configConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认配置更改</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>您确定要保存这些配置更改吗？</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        某些配置更改可能需要重启系统才能完全生效。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmSaveConfig">确认保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS - 优先使用本地版本 -->
    <script src="/static/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <!-- CDN备用加载 -->
    <script>
        // 如果本地Bootstrap JS加载失败，尝试CDN
        setTimeout(function() {
            if (typeof bootstrap === 'undefined') {
                console.warn('本地Bootstrap JS加载失败，尝试CDN');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
                script.onload = function() {
                    console.log('CDN Bootstrap JS加载成功');
                    // 重新初始化UI组件
                    if (typeof window.configManager === 'undefined' && typeof UserConfigManager !== 'undefined') {
                        window.configManager = new UserConfigManager();
                    }
                };
                document.head.appendChild(script);
            }
        }, 2000);
    </script>

    <!-- 自定义JavaScript -->
    <script src="/static/js/app-utils.js?v=20250119_80"></script>
    <script src="/static/js/user-config-manager.js?v=20250119_80"></script>
    <script src="/static/js/settings-init.js?v=20250119_80"></script>
</body>
</html>
