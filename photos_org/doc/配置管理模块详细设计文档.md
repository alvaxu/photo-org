# 家庭版智能照片系统 - 用户配置界面详细设计文档

## 一、文档基础信息

| 项目名称 | 家庭版智能照片系统 | 文档类型 | 用户配置界面详细设计文档 |
| -------- | ------------------------- | -------- | ----------------------- |
| 文档版本 | V4.0 | 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 |
| 编写人 | AI助手 | 编写日期 | 2025年1月19日 |
| 关联文档 | 《服务人员配置管理手册》《照片导入模块详细设计文档》《搜索检索模块详细设计文档》 | | |

## 二、用户配置界面概述

### 2.1 设计目标

用户配置界面是家庭照片系统的参数调整中心，专门为普通用户设计。通过简洁直观的Web界面，让用户能够方便地调整系统参数，优化使用体验，满足个人使用需求。

### 2.2 设计原则

- **用户友好**：界面简洁直观，适合家庭用户
- **功能聚焦**：只暴露用户真正需要调整的参数
- **安全可靠**：敏感信息通过环境变量管理，存储目录修改仅限本地访问
- **向后兼容**：不影响现有系统功能
- **布局优化**：紧凑的布局设计，提高空间利用率

### 2.3 技术选型

- **前端界面**：Bootstrap + JavaScript
- **后端API**：FastAPI
- **配置存储**：JSON配置文件 + 环境变量
- **配置验证**：Pydantic数据验证

## 三、用户配置参数设计

### 3.1 用户配置参数概览

用户配置界面只暴露用户真正需要调整的11个参数，分为4个配置分类：

| 配置分类 | 参数数量 | 说明 |
|---------|----------|------|
| **AI服务设置** | 2个 | 大模型选择、API密钥 |
| **存储设置** | 5个 | 存储路径、缩略图质量/尺寸、照片大小限制 |
| **界面设置** | 2个 | 每页显示照片数、相似照片显示数量 |
| **搜索设置** | 2个 | 相似度阈值、重复检测阈值 |
| **总计** | **11个** | 用户可配置参数 |

**注意**：热门标签和热门分类配置已从用户界面移除，因为前端没有实际使用这些数据。

### 3.2 用户配置参数详细说明

#### 3.2.1 AI服务设置 (2个参数)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 实现状态 |
|--------|------|--------|------|------|----------|
| model | string | qwen-vl-plus-2025-08-15 | 动态配置 | 大模型选择（从available_models中选择） | ✅ 已实现 |
| api_key | string | "" | - | API密钥（环境变量优先） | ✅ 已实现 |

#### 3.2.2 存储设置 (5个参数)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 实现状态 |
|--------|------|--------|------|------|----------|
| base_path | string | "./storage" | - | 照片存储目录 | ✅ 已实现 |
| database_path | string | "./photo_db/photos.db" | - | 数据库文件位置 | ✅ 已实现 |
| thumbnail_quality | int | 42 | 1-100 | 缩略图质量（%） | ✅ 已实现 |
| thumbnail_size | int | 300 | 100-1000 | 缩略图尺寸（像素） | ✅ 已实现 |
| max_file_size | int | 52428800 | 25MB-200MB | 照片大小限制 | ✅ 已实现 |

#### 3.2.3 界面设置 (2个参数)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 实现状态 |
|--------|------|--------|------|------|----------|
| photos_per_page | int | 18 | 6/12/18/24/30 | 每页显示照片数量 | ✅ 已实现 |
| similar_photos_limit | int | 8 | 4/8/12 | 相似照片显示数量 | ✅ 已实现 |

**注意**：热门标签和热门分类配置已从用户界面移除，因为前端没有实际使用这些数据。

#### 3.2.4 搜索设置 (2个参数)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 实现状态 |
|--------|------|--------|------|------|----------|
| similarity_threshold | float | 0.6 | 0.0-1.0 | 相似度阈值 | ✅ 已实现 |
| duplicate_threshold | int | 5 | 1-20 | 重复检测阈值 | ✅ 已实现 |

### 3.3 配置参数映射

用户配置参数在 `config.json` 中的映射关系：

```json
{
  "dashscope": {
    "api_key": "${DASHSCOPE_API_KEY}",
    "model": "qwen-vl-plus-latest",
    "available_models": [
      "qwen-vl-plus-latest",
      "qwen-vl-plus-2025-08-15",
      "qwen-vl-plus-2025-05-07",
      "qwen-vl-plus-2025-01-25"
    ]
  },
  "storage": {
    "base_path": "./photos_storage",
    "thumbnail_quality": 85,
    "thumbnail_size": 300
  },
  "database": {
    "path": "./data/photos.db"
  },
  "system": {
    "max_file_size": 52428800
  },
  "ui": {
    "photos_per_page": 12,
    "similar_photos_limit": 8
  },
  "search": {
    "similarity_threshold": 0.8
  },
  "analysis": {
    "duplicate_threshold": 5
  }
}
```

### 3.4 环境变量支持

#### 3.4.1 DashScope API密钥优先级处理
```python
def _process_dashscope_api_key(self, config_data: Dict[str, Any]) -> str:
    """处理DashScope API密钥的优先级"""
    # 1. 优先从环境变量获取
    env_key = os.getenv("DASHSCOPE_API_KEY")
    if env_key:
        return env_key
    
    # 2. 从config.json获取
    if "dashscope" in config_data and "api_key" in config_data["dashscope"]:
        api_key = config_data["dashscope"]["api_key"]
        # 如果不是环境变量格式，直接使用
        if not (isinstance(api_key, str) and api_key.startswith("${")):
            return api_key
    
    # 3. 都没有则返回空字符串
    return ""
```

#### 3.4.2 支持的环境变量
```bash
# DashScope配置
export DASHSCOPE_API_KEY=your_api_key_here

# 存储配置
export STORAGE_BASE_PATH=./photos_storage
export THUMBNAIL_SIZE=300
export THUMBNAIL_QUALITY=85

# 系统配置
export MAX_FILE_SIZE=52428800

# 界面配置
export PHOTOS_PER_PAGE=12
export SIMILAR_PHOTOS_LIMIT=8
export HOT_TAGS_LIMIT=10
export HOT_CATEGORIES_LIMIT=10

# 搜索配置
export SIMILARITY_THRESHOLD=0.8
export DUPLICATE_THRESHOLD=5
```

## 四、安全特性设计

### 4.1 远程访问限制

#### 4.1.1 存储目录修改限制
- **限制范围**：照片存储目录配置项
- **限制原因**：防止远程误操作导致数据丢失和数据库信息失效
- **实现方式**：前端检测 + 后端验证双重保护

#### 4.1.2 前端检测机制
```javascript
checkRemoteAccess() {
    const hostname = window.location.hostname;
    const isLocalAccess = hostname === 'localhost' || 
                         hostname === '127.0.0.1' || 
                         hostname === '0.0.0.0' ||
                         hostname === '' ||
                         window.location.protocol === 'file:';
    
    if (!isLocalAccess) {
        // 隐藏存储目录配置区域
        // 显示远程访问提示
    }
}
```

#### 4.1.3 后端验证机制
```python
def is_local_access(request: Request) -> bool:
    """检测是否为本地访问"""
    client_ip = request.client.host
    local_ips = ['127.0.0.1', 'localhost', '::1', '0.0.0.0']
    return client_ip in local_ips or client_ip.startswith('127.') or client_ip.startswith('192.168.') or client_ip.startswith('10.')
```

#### 4.1.4 用户体验设计
- **本地访问**：正常显示存储目录配置，包含数据迁移警告
- **远程访问**：隐藏配置区域，显示"此配置项仅限本地访问"提示

### 4.2 数据安全保护

#### 4.2.1 存储目录修改警告
- **警告位置**：存储目录配置区域
- **警告内容**：提醒用户先复制数据再更改目录
- **视觉设计**：黄色警告框，包含警告图标

#### 4.2.2 API权限控制
- **选择目录API**：仅限本地访问
- **配置更新API**：存储目录修改仅限本地访问
- **错误处理**：返回403状态码和明确错误信息

## 五、用户配置界面设计

### 4.1 设计理念

基于两层次配置管理设计：
1. **用户界面配置**：只暴露用户真正需要调整的参数，界面简洁直观
2. **高级配置**：开发者通过直接编辑 `config.json` 进行深度调试

### 4.2 界面布局设计

#### 4.2.1 整体布局
- **卡片式设计**：每个配置分类使用独立的卡片
- **响应式布局**：支持桌面和移动设备
- **直观操作**：使用滑块、下拉框、文件选择器等直观控件

#### 4.2.2 配置分类布局
```
┌─────────────────────────────────────┐
│  AI服务设置 (2个参数)                │
├─────────────────────────────────────┤
│  存储设置 (5个参数)                  │
│  - 照片存储目录 + 照片大小限制 (一行)  │
│  - 缩略图质量 + 缩略图尺寸 (一行)     │
├─────────────────────────────────────┤
│  界面设置 (2个参数)                  │
│  - 每页显示照片数 + 相似照片显示数量   │
├─────────────────────────────────────┤
│  搜索设置 (2个参数)                  │
│  - 相似度阈值 + 重复检测阈值 (一行)   │
├─────────────────────────────────────┤
│  操作按钮 (保存/重置/导出)            │
└─────────────────────────────────────┘
```

#### 4.2.3 布局优化特性
- **紧凑布局**：相关配置项合并到同一行，提高空间利用率
- **存储设置**：照片存储目录(8列) + 照片大小限制(4列)
- **界面设置**：每页显示照片数(6列) + 相似照片显示数量(6列)
- **搜索设置**：相似度阈值(6列) + 重复检测阈值(6列)
- **远程访问**：存储目录配置在远程访问时自动隐藏

### 4.3 配置控件设计

#### 4.3.1 控件类型选择

| 配置项 | 控件类型 | 配置方式 | 说明 |
|--------|----------|----------|------|
| **AI服务设置** | | | |
| 大模型选择 | 下拉选择框 | `<select>` 元素，动态选项 | 用户从服务人员配置的available_models中选择 |
| API密钥 | 密码输入框 | `<input type="password">` | 支持手动输入，留空则使用环境变量 |
| **存储设置** | | | |
| 照片存储目录 | 路径输入框 + 目录选择按钮 | 文本输入 + 文件浏览器 | 点击按钮打开系统目录选择器 |
| 数据库文件位置 | 路径输入框 + 文件选择按钮 | 文本输入 + 文件浏览器 | 点击按钮打开系统文件选择器 |
| 缩略图质量 | 范围滑块 | `<input type="range">` | 1-100%，实时显示当前值 |
| 缩略图尺寸 | 范围滑块 | `<input type="range">` | 100-1000像素，实时显示当前值 |
| 照片大小限制 | 下拉选择框 | `<select>` 元素，预设选项 | 25MB/50MB/100MB/200MB 选择 |
| **界面设置** | | | |
| 每页显示照片数 | 下拉选择框 | `<select>` 元素，预设选项 | 6/12/20/50张 选择 |
| 相似照片显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 4/8/12张 选择 |
| 热门标签显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 5/10/20个 选择 |
| 热门分类显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 5/10/20个 选择 |
| **搜索设置** | | | |
| 相似度阈值 | 范围滑块 | `<input type="range">` | 0.0-1.0，步长0.1，实时显示当前值 |
| 重复检测阈值 | 范围滑块 | `<input type="range">` | 1-20，实时显示当前值 |

## 五、用户配置界面实现

#### 5.3.1 配置控件详细说明

| 配置项 | 控件类型 | 配置方式 | 说明 |
|--------|----------|----------|------|
| **AI服务设置** | | | |
| 大模型选择 | 下拉选择框 | `<select>` 元素，预设选项 | 用户从 qwen-vl-plus/qwen-vl-chat 中选择 |
| API密钥 | 密码输入框 | `<input type="password">` | 支持手动输入，留空则使用环境变量 |
| **存储设置** | | | |
| 照片存储目录 | 路径输入框 + 目录选择按钮 | 文本输入 + 文件浏览器 | 点击按钮打开系统目录选择器 |
| 数据库文件位置 | 路径输入框 + 文件选择按钮 | 文本输入 + 文件浏览器 | 点击按钮打开系统文件选择器 |
| 缩略图质量 | 范围滑块 | `<input type="range">` | 1-100%，实时显示当前值 |
| 缩略图尺寸 | 范围滑块 | `<input type="range">` | 100-1000像素，实时显示当前值 |
| 照片大小限制 | 下拉选择框 | `<select>` 元素，预设选项 | 25MB/50MB/100MB/200MB 选择 |
| **界面设置** | | | |
| 每页显示照片数 | 下拉选择框 | `<select>` 元素，预设选项 | 6/12/20/50张 选择 |
| 相似照片显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 4/8/12张 选择 |
| 热门标签显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 5/10/20个 选择 |
| 热门分类显示数量 | 下拉选择框 | `<select>` 元素，预设选项 | 5/10/20个 选择 |
| **搜索设置** | | | |
| 相似度阈值 | 范围滑块 | `<input type="range">` | 0.0-1.0，步长0.1，实时显示当前值 |
| 重复检测阈值 | 范围滑块 | `<input type="range">` | 1-20，实时显示当前值 |

## 六、配置管理API接口设计 ✅ 已实现

### 6.1 用户配置管理API

#### 6.1.1 获取用户配置 ✅ 已实现
**接口路径**：`GET /api/v1/config/user`
**功能描述**：获取用户可配置的参数

**实际响应格式**：
```json
{
  "success": true,
  "data": {
    "dashscope": {
      "model": "qwen-vl-plus-2025-08-15",
      "api_key": "sk-xxx...",
      "available_models": ["qwen-vl-plus", "qwen-vl-plus-latest", "qwen-vl-plus-2025-08-15"]
    },
    "storage": {
      "base_path": "./storage",
      "thumbnail_quality": 86,
      "thumbnail_size": 300
    },
    "database": {
      "path": "./photo_db/photos.db"
    },
    "system": {
      "max_file_size": 52428800
    },
    "ui": {
      "photos_per_page": 18,
      "similar_photos_limit": 8,
      "hot_tags_limit": 10,
      "hot_categories_limit": 10
    },
    "search": {
      "similarity_threshold": 0.6
    },
    "analysis": {
      "duplicate_threshold": 5
    }
  }
}
```

#### 6.1.2 更新用户配置 ✅ 已实现
**接口路径**：`PUT /api/v1/config/user`
**功能描述**：更新用户配置

**请求体**：
```json
{
  "dashscope": {
    "model": "qwen-vl-plus-latest",
    "api_key": "sk-new-key"
  },
  "storage": {
    "base_path": "./new_storage",
    "thumbnail_quality": 90,
    "thumbnail_size": 400
  },
  "ui": {
    "photos_per_page": 24,
    "similar_photos_limit": 12
  }
}
```

**实际响应格式**：
```json
{
  "success": true,
  "message": "用户配置更新成功",
  "data": {
    // 更新后的配置数据
  }
}
```

#### 6.1.3 重置用户配置 ✅ 已实现
**接口路径**：`POST /api/v1/config/user/reset`
**功能描述**：重置用户配置为默认值

**实际响应格式**：
```json
{
  "success": true,
  "message": "用户配置重置成功",
  "data": {
    // 重置后的配置数据
  }
}
```

#### 6.1.4 获取默认配置 ✅ 已实现
**接口路径**：`GET /api/v1/config/defaults`
**功能描述**：获取系统默认配置值（用于配置页面显示默认值）

**实际响应格式**：
```json
{
  "success": true,
  "data": {
    "dashscope": {
      "model": "qwen-vl-plus-2025-08-15",
      "api_key": "sk-bfff6cdc92e84b2f89064cd382fdbe4a",
      "available_models": ["qwen-vl-plus", "qwen-vl-plus-latest", "qwen-vl-plus-2025-08-15"]
    },
    "storage": {
      "base_path": "./storage",
      "thumbnail_quality": 42,
      "thumbnail_size": 300
    },
    "database": {
      "path": "./photo_db/photos.db"
    },
    "system": {
      "max_file_size": 52428800
    },
    "ui": {
      "photos_per_page": 18,
      "similar_photos_limit": 8,
      "hot_tags_limit": 10,
      "hot_categories_limit": 10
    },
    "search": {
      "similarity_threshold": 0.6
    },
    "analysis": {
      "duplicate_threshold": 5
    }
  }
}
```

#### 6.1.5 获取可用模型列表 ✅ 已实现
**接口路径**：`GET /api/v1/config/models`
**功能描述**：获取可用的AI模型列表

**实际响应格式**：
```json
{
  "success": true,
  "data": {
    "available_models": [
      "qwen-vl-plus",
      "qwen-vl-plus-latest", 
      "qwen-vl-plus-2025-08-15",
      "qwen-vl-plus-2025-05-07",
      "qwen-vl-plus-2025-01-25"
    ],
    "current_model": "qwen-vl-plus-2025-08-15"
  }
}
```

#### 6.1.6 选择目录 ✅ 已实现
**接口路径**：`POST /api/v1/config/select-directory`
**功能描述**：打开系统目录选择对话框

**实际响应格式**：
```json
{
  "success": true,
  "path": "D:/photos"
}
```

#### 6.1.7 选择数据库文件 ✅ 已实现
**接口路径**：`POST /api/v1/config/select-database-file`
**功能描述**：打开系统文件选择对话框

**实际响应格式**：
```json
{
  "success": true,
  "path": "D:/data/photos.db"
}
```

### 6.2 高级配置管理API

#### 6.2.1 获取完整配置 ✅ 已实现
**接口路径**：`GET /api/v1/config/full`
**功能描述**：获取完整系统配置（包含高级参数）

#### 6.2.2 更新完整配置 ✅ 已实现
**接口路径**：`PUT /api/v1/config/full`
**功能描述**：更新完整系统配置

#### 6.2.3 导出配置 ✅ 已实现
**接口路径**：`GET /api/v1/config/export`
**功能描述**：导出完整配置文件

#### 6.2.4 重新加载配置 ✅ 已实现
**接口路径**：`POST /api/v1/config/reload`
**功能描述**：手动重新加载配置

## 七、前端实现设计

##### 7.1 下拉选择框实现
```html
<!-- 大模型选择 -->
<select class="form-select" id="aiModel">
    <option value="qwen-vl-plus">qwen-vl-plus (推荐)</option>
    <option value="qwen-vl-chat">qwen-vl-chat</option>
</select>

<!-- 照片大小限制 -->
<select class="form-select" id="maxFileSize">
    <option value="26214400">25MB</option>
    <option value="52428800" selected>50MB (推荐)</option>
    <option value="104857600">100MB</option>
    <option value="209715200">200MB</option>
</select>
```

##### 5.3.2.2 范围滑块实现
```html
<!-- 缩略图质量滑块 -->
<div class="mb-3">
    <label for="thumbnailQuality" class="form-label">缩略图质量</label>
    <input type="range" class="form-range" id="thumbnailQuality" 
           min="1" max="100" value="85" step="1">
    <div class="d-flex justify-content-between">
        <small>1%</small>
        <small id="thumbnailQualityValue">85%</small>
        <small>100%</small>
    </div>
    <div class="form-text">影响存储空间和显示效果</div>
</div>

<!-- 相似度阈值滑块 -->
<div class="mb-3">
    <label for="similarityThreshold" class="form-label">相似度阈值</label>
    <input type="range" class="form-range" id="similarityThreshold" 
           min="0" max="1" step="0.1" value="0.8">
    <div class="d-flex justify-content-between">
        <small>0.0 (宽松)</small>
        <small id="similarityThresholdValue">0.8</small>
        <small>1.0 (严格)</small>
    </div>
    <div class="form-text">用于相似照片搜索的阈值</div>
</div>
```

##### 5.3.2.3 路径选择实现
```html
<!-- 照片存储目录选择 -->
<div class="mb-3">
    <label for="photosPath" class="form-label">照片存储目录</label>
    <div class="input-group">
        <input type="text" class="form-control" id="photosPath" 
               value="./photos_storage" placeholder="选择照片存储目录">
        <button class="btn btn-outline-secondary" type="button" id="selectPhotosPath">
            <i class="bi bi-folder"></i> 选择目录
        </button>
    </div>
    <div class="form-text">照片文件的存储位置</div>
</div>

<!-- 数据库文件位置选择 -->
<div class="mb-3">
    <label for="databasePath" class="form-label">数据库文件位置</label>
    <div class="input-group">
        <input type="text" class="form-control" id="databasePath" 
               value="./data/photos.db" placeholder="选择数据库文件">
        <button class="btn btn-outline-secondary" type="button" id="selectDatabasePath">
            <i class="bi bi-file-earmark"></i> 选择文件
        </button>
    </div>
    <div class="form-text">数据库文件的存储位置</div>
</div>
```

##### 5.3.2.4 密码输入框实现
```html
<!-- API密钥输入 -->
<div class="mb-3">
    <label for="apiKey" class="form-label">API密钥</label>
    <input type="password" class="form-control" id="apiKey" 
           placeholder="留空则使用环境变量 DASHSCOPE_API_KEY">
    <div class="form-text">优先使用环境变量 DASHSCOPE_API_KEY</div>
</div>
```

#### 5.3.3 控件交互说明

##### 5.3.3.1 范围滑块交互
- **实时更新**：滑块拖动时，右侧数值实时更新
- **数值显示**：显示当前值，带单位（%、px等）
- **范围提示**：左右两侧显示最小值和最大值
- **步长控制**：相似度阈值步长0.1，其他为1

##### 5.3.3.2 下拉选择框交互
- **预设选项**：所有选项都是预设的，用户只能选择
- **推荐标识**：推荐选项用"(推荐)"标识
- **默认选择**：页面加载时自动选择推荐值

##### 5.3.3.3 路径选择交互
- **双重输入**：支持手动输入和文件浏览器选择
- **文件浏览器**：点击按钮打开系统文件/目录选择器
- **路径验证**：输入后验证路径的有效性
- **降级方案**：不支持文件API时使用prompt输入

**文件浏览器实现方案：**

1. **目录选择器**（照片存储目录）
   ```javascript
   // 使用后端API调用系统原生目录选择对话框
   async selectDirectory(inputId) {
       const input = document.getElementById(inputId);
       try {
           const response = await fetch('/api/v1/config/select-directory', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' }
           });
           const result = await response.json();
           if (result.success) {
               input.value = result.path;
               this.markAsChanged();
               this.updateCurrentValue(inputId + 'Current', result.path);
           }
       } catch (error) {
           console.error('选择目录失败:', error);
           alert('选择目录失败: ' + error.message);
       }
   }
   ```

2. **文件选择器**（数据库文件位置）
   ```javascript
   // 使用后端API调用系统原生文件选择对话框
   async selectFile(inputId) {
       const input = document.getElementById(inputId);
       try {
           const response = await fetch('/api/v1/config/select-database-file', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' }
           });
           const result = await response.json();
           if (result.success) {
               input.value = result.path;
               this.markAsChanged();
               this.updateCurrentValue(inputId + 'Current', result.path);
           }
       } catch (error) {
           console.error('选择数据库文件失败:', error);
           alert('选择数据库文件失败: ' + error.message);
       }
   }
   ```

3. **后端API实现**
   ```python
   # 后端使用tkinter实现原生系统对话框
   @router.post("/select-directory")
   async def select_directory():
       try:
           import tkinter as tk
           from tkinter import filedialog
           root = tk.Tk()
           root.withdraw()
           directory = filedialog.askdirectory(
               title="选择照片存储目录",
               initialdir="C:\\"
           )
           root.destroy()
           if directory:
               return {"success": True, "path": directory}
           else:
               return {"success": False, "message": "用户取消选择"}
       except Exception as e:
           return {"success": False, "message": f"选择目录失败: {str(e)}"}
   ```

##### 5.3.3.4 密码输入框交互
- **隐藏输入**：输入时显示为星号
- **环境变量提示**：明确提示优先使用环境变量
- **留空处理**：留空时自动使用环境变量值

#### 5.3.4 响应式设计
- **移动端适配**：滑块在小屏幕上保持可用性
- **标签布局**：小屏幕时标签和控件垂直排列
- **按钮大小**：触摸友好的按钮尺寸

#### 5.3.5 页面布局
```html
<!-- 用户配置页面 -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-gear me-2"></i>系统设置</h2>
            <p class="text-muted">调整系统参数以优化性能和使用体验</p>
        </div>
    </div>
    
    <!-- 配置表单 -->
    <form id="userConfigForm">
        <!-- AI服务设置 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-robot me-2"></i>AI服务设置</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="aiModel" class="form-label">大模型选择</label>
                            <select class="form-select" id="aiModel">
                                <option value="qwen-vl-plus">qwen-vl-plus (推荐)</option>
                                <option value="qwen-vl-chat">qwen-vl-chat</option>
                            </select>
                            <div class="form-text">选择用于图像分析的AI模型</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="apiKey" class="form-label">API密钥</label>
                            <input type="password" class="form-control" id="apiKey" 
                                   placeholder="留空则使用环境变量">
                            <div class="form-text">优先使用环境变量 DASHSCOPE_API_KEY</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 存储设置 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-folder me-2"></i>存储设置</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="photosPath" class="form-label">照片存储目录</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="photosPath" 
                                       value="./photos_storage">
                                <button class="btn btn-outline-secondary" type="button" id="selectPhotosPath">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>
                            <div class="form-text">照片文件的存储位置</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="databasePath" class="form-label">数据库文件位置</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="databasePath" 
                                       value="./data/photos.db">
                                <button class="btn btn-outline-secondary" type="button" id="selectDatabasePath">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>
                            <div class="form-text">数据库文件的存储位置</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="thumbnailQuality" class="form-label">缩略图质量</label>
                            <input type="range" class="form-range" id="thumbnailQuality" 
                                   min="1" max="100" value="85">
                            <div class="d-flex justify-content-between">
                                <small>1%</small>
                                <small id="thumbnailQualityValue">85%</small>
                                <small>100%</small>
                            </div>
                            <div class="form-text">影响存储空间和显示效果</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="thumbnailSize" class="form-label">缩略图尺寸</label>
                            <input type="range" class="form-range" id="thumbnailSize" 
                                   min="100" max="1000" value="300">
                            <div class="d-flex justify-content-between">
                                <small>100px</small>
                                <small id="thumbnailSizeValue">300px</small>
                                <small>1000px</small>
                            </div>
                            <div class="form-text">缩略图的像素大小</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="maxFileSize" class="form-label">照片大小限制</label>
                            <select class="form-select" id="maxFileSize">
                                <option value="26214400">25MB</option>
                                <option value="52428800" selected>50MB (推荐)</option>
                                <option value="104857600">100MB</option>
                                <option value="209715200">200MB</option>
                            </select>
                            <div class="form-text">单张照片的最大大小</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 界面设置 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-display me-2"></i>界面设置</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="photosPerPage" class="form-label">每页显示照片数</label>
                            <select class="form-select" id="photosPerPage">
                                <option value="6">6张</option>
                                <option value="12" selected>12张 (推荐)</option>
                                <option value="20">20张</option>
                                <option value="50">50张</option>
                            </select>
                            <div class="form-text">照片列表每页显示的数量</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="similarPhotosLimit" class="form-label">相似照片显示数量</label>
                            <select class="form-select" id="similarPhotosLimit">
                                <option value="4">4张</option>
                                <option value="8" selected>8张 (推荐)</option>
                                <option value="12">12张</option>
                            </select>
                            <div class="form-text">查看相似照片时显示的数量</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="hotTagsLimit" class="form-label">热门标签显示数量</label>
                            <select class="form-select" id="hotTagsLimit">
                                <option value="5">5个</option>
                                <option value="10" selected>10个 (推荐)</option>
                                <option value="20">20个</option>
                            </select>
                            <div class="form-text">侧边栏显示的热门标签数量</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="hotCategoriesLimit" class="form-label">热门分类显示数量</label>
                            <select class="form-select" id="hotCategoriesLimit">
                                <option value="5">5个</option>
                                <option value="10" selected>10个 (推荐)</option>
                                <option value="20">20个</option>
                            </select>
                            <div class="form-text">侧边栏显示的热门分类数量</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 搜索设置 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-search me-2"></i>搜索设置</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="similarityThreshold" class="form-label">相似度阈值</label>
                            <input type="range" class="form-range" id="similarityThreshold" 
                                   min="0" max="1" step="0.1" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small>0.0 (宽松)</small>
                                <small id="similarityThresholdValue">0.8</small>
                                <small>1.0 (严格)</small>
                            </div>
                            <div class="form-text">用于相似照片搜索的阈值</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="duplicateThreshold" class="form-label">重复检测阈值</label>
                            <input type="range" class="form-range" id="duplicateThreshold" 
                                   min="1" max="20" value="5">
                            <div class="d-flex justify-content-between">
                                <small>1 (严格)</small>
                                <small id="duplicateThresholdValue">5</small>
                                <small>20 (宽松)</small>
                            </div>
                            <div class="form-text">用于重复照片检测的阈值</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" id="resetConfig">
                            <i class="bi bi-arrow-clockwise me-1"></i>重置为默认值
                        </button>
                        <button type="button" class="btn btn-outline-info" id="exportConfig">
                            <i class="bi bi-download me-1"></i>导出配置
                        </button>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary" id="saveConfig">
                            <i class="bi bi-check-lg me-1"></i>保存配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
```

### 5.4 用户配置管理JavaScript

```javascript
/**
 * 用户配置管理前端实现
 * 基于两层次配置管理设计
 */
class UserConfigManager {
    constructor() {
        this.currentConfig = {};
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadConfig();
    }
    
    bindEvents() {
        // 保存配置
        document.getElementById('saveConfig').addEventListener('click', (e) => {
            e.preventDefault();
            this.saveConfig();
        });
        
        // 重置配置
        document.getElementById('resetConfig').addEventListener('click', () => {
            this.resetConfig();
        });
        
        // 导出配置
        document.getElementById('exportConfig').addEventListener('click', () => {
            this.exportConfig();
        });
        
        // 路径选择按钮
        document.getElementById('selectPhotosPath').addEventListener('click', () => {
            this.selectDirectory('photosPath');
        });
        
        document.getElementById('selectDatabasePath').addEventListener('click', () => {
            this.selectFile('databasePath');
        });
        
        // 范围滑块实时更新
        this.bindRangeSliders();
    }
    
    bindRangeSliders() {
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', (e) => {
                const valueElement = document.getElementById(e.target.id + 'Value');
                if (valueElement) {
                    if (e.target.id === 'thumbnailQuality') {
                        valueElement.textContent = e.target.value + '%';
                    } else if (e.target.id === 'thumbnailSize') {
                        valueElement.textContent = e.target.value + 'px';
                    } else {
                        valueElement.textContent = e.target.value;
                    }
                }
            });
        });
    }
    
    async loadConfig() {
        try {
            const response = await fetch('/api/v1/config/user');
            const config = await response.json();
            
            this.currentConfig = config;
            this.populateForm(config);
        } catch (error) {
            console.error('加载配置失败:', error);
            this.showError('加载配置失败: ' + error.message);
        }
    }
    
    populateForm(config) {
        // AI服务配置
        if (config.dashscope) {
            document.getElementById('aiModel').value = config.dashscope.model || 'qwen-vl-plus';
            document.getElementById('apiKey').value = config.dashscope.api_key || '';
        }
        
        // 存储配置
        if (config.storage) {
            document.getElementById('photosPath').value = config.storage.base_path || './photos_storage';
            document.getElementById('databasePath').value = config.database?.path || './data/photos.db';
            document.getElementById('thumbnailQuality').value = config.storage.thumbnail_quality || 85;
            document.getElementById('thumbnailSize').value = config.storage.thumbnail_size || 300;
            this.updateRangeValue('thumbnailQuality');
            this.updateRangeValue('thumbnailSize');
        }
        
        // 照片大小限制
        if (config.system) {
            document.getElementById('maxFileSize').value = config.system.max_file_size || 52428800;
        }
        
        // 界面配置
        if (config.ui) {
            document.getElementById('photosPerPage').value = config.ui.photos_per_page || 12;
            document.getElementById('similarPhotosLimit').value = config.ui.similar_photos_limit || 8;
            document.getElementById('hotTagsLimit').value = config.ui.hot_tags_limit || 10;
            document.getElementById('hotCategoriesLimit').value = config.ui.hot_categories_limit || 10;
        }
        
        // 搜索配置
        if (config.search) {
            document.getElementById('similarityThreshold').value = config.search.similarity_threshold || 0.8;
            this.updateRangeValue('similarityThreshold');
        }
        
        // 重复检测配置
        if (config.analysis) {
            document.getElementById('duplicateThreshold').value = config.analysis.duplicate_threshold || 5;
            this.updateRangeValue('duplicateThreshold');
        }
    }
    
    updateRangeValue(sliderId) {
        const slider = document.getElementById(sliderId);
        const valueElement = document.getElementById(sliderId + 'Value');
        if (slider && valueElement) {
            if (sliderId === 'thumbnailQuality') {
                valueElement.textContent = slider.value + '%';
            } else if (sliderId === 'thumbnailSize') {
                valueElement.textContent = slider.value + 'px';
            } else {
                valueElement.textContent = slider.value;
            }
        }
    }
    
    async saveConfig() {
        try {
            const configData = this.collectFormData();
            
            const response = await fetch('/api/v1/config/user', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showSuccess('配置保存成功，部分配置需要重启应用才能生效');
            } else {
                this.showError('配置保存失败: ' + result.message);
            }
        } catch (error) {
            console.error('保存配置失败:', error);
            this.showError('保存配置失败: ' + error.message);
        }
    }
    
    collectFormData() {
        return {
            dashscope: {
                model: document.getElementById('aiModel').value,
                api_key: document.getElementById('apiKey').value || null
            },
            storage: {
                base_path: document.getElementById('photosPath').value,
                thumbnail_quality: parseInt(document.getElementById('thumbnailQuality').value),
                thumbnail_size: parseInt(document.getElementById('thumbnailSize').value)
            },
            database: {
                path: document.getElementById('databasePath').value
            },
            system: {
                max_file_size: parseInt(document.getElementById('maxFileSize').value)
            },
            ui: {
                photos_per_page: parseInt(document.getElementById('photosPerPage').value),
                similar_photos_limit: parseInt(document.getElementById('similarPhotosLimit').value),
                hot_tags_limit: parseInt(document.getElementById('hotTagsLimit').value),
                hot_categories_limit: parseInt(document.getElementById('hotCategoriesLimit').value)
            },
            search: {
                similarity_threshold: parseFloat(document.getElementById('similarityThreshold').value)
            },
            analysis: {
                duplicate_threshold: parseInt(document.getElementById('duplicateThreshold').value)
            }
        };
    }
    
    async resetConfig() {
        if (confirm('确定要重置所有用户配置为默认值吗？\n\n注意：这将重置所有用户界面配置，但不会影响高级配置。')) {
            try {
                const response = await fetch('/api/v1/config/user/reset', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess('配置重置成功');
                    this.loadConfig();
                } else {
                    this.showError('配置重置失败: ' + result.message);
                }
            } catch (error) {
                console.error('重置配置失败:', error);
                this.showError('重置配置失败: ' + error.message);
            }
        }
    }
    
    async exportConfig() {
        try {
            const response = await fetch('/api/v1/config/export');
            const blob = await response.blob();
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'user_config_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            this.showSuccess('配置导出成功');
        } catch (error) {
            console.error('导出配置失败:', error);
            this.showError('导出配置失败: ' + error.message);
        }
    }
    
    selectDirectory(inputId) {
        // 目录选择实现
        const input = document.getElementById(inputId);
        
        // 方案1：使用HTML5 File API（需要用户交互）
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.webkitdirectory = true; // 选择目录
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                // 获取选择的目录路径
                const directoryPath = files[0].webkitRelativePath.split('/')[0];
                input.value = directoryPath;
            }
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
        
        // 方案2：降级方案 - 使用prompt
        // const path = prompt('请输入目录路径:', input.value);
        // if (path) {
        //     input.value = path;
        // }
    }
    
    selectFile(inputId) {
        // 文件选择实现
        const input = document.getElementById(inputId);
        
        // 方案1：使用HTML5 File API
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.db'; // 只接受数据库文件
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                input.value = files[0].name;
            }
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
        
        // 方案2：降级方案 - 使用prompt
        // const path = prompt('请输入文件路径:', input.value);
        // if (path) {
        //     input.value = path;
        // }
    }
    
    showSuccess(message) {
        // 使用现有的通知系统
        if (window.showSuccess) {
            window.showSuccess(message);
        } else {
            alert('成功: ' + message);
        }
    }
    
    showError(message) {
        // 使用现有的通知系统
        if (window.showError) {
            window.showError(message);
        } else {
            alert('错误: ' + message);
        }
    }
}

// 初始化用户配置管理器
document.addEventListener('DOMContentLoaded', () => {
    new UserConfigManager();
});
```

## 六、API接口设计

### 6.1 用户配置管理API

#### 6.1.1 获取用户配置
```python
@router.get("/config/user")
async def get_user_config():
    """获取用户可配置的参数"""
    try:
        config = config_manager.get_user_config()
        return config
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取用户配置失败: {str(e)}")
```

#### 6.1.2 更新用户配置
```python
@router.put("/config/user")
async def update_user_config(config_data: Dict[str, Any]):
    """更新用户配置"""
    try:
        result = config_manager.update_user_config(config_data)
        return {"success": True, "message": "用户配置更新成功", "data": result}
    except Exception as e:
        return {"success": False, "message": f"用户配置更新失败: {str(e)}"}
```

#### 6.1.3 重置用户配置
```python
@router.post("/config/user/reset")
async def reset_user_config():
    """重置用户配置为默认值"""
    try:
        result = config_manager.reset_user_config()
        return {"success": True, "message": "用户配置重置成功", "data": result}
    except Exception as e:
        return {"success": False, "message": f"用户配置重置失败: {str(e)}"}
```

#### 6.1.4 导出配置
```python
@router.get("/config/export")
async def export_config():
    """导出完整配置文件"""
    try:
        config_data = config_manager.export_config()
        return FileResponse(
            path=config_data["file_path"],
            filename="config.json",
            media_type="application/json"
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"导出配置失败: {str(e)}")
```

### 6.2 高级配置管理API（开发者专用）

#### 6.2.1 获取完整配置
```python
@router.get("/config/full")
async def get_full_config():
    """获取完整系统配置（包含高级参数）"""
    try:
        config = config_manager.get_full_config()
        return config
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取完整配置失败: {str(e)}")
```

#### 6.2.2 更新完整配置
```python
@router.put("/config/full")
async def update_full_config(config_data: Dict[str, Any]):
    """更新完整系统配置"""
    try:
        result = config_manager.update_full_config(config_data)
        return {"success": True, "message": "完整配置更新成功", "data": result}
    except Exception as e:
        return {"success": False, "message": f"完整配置更新失败: {str(e)}"}
```

## 七、实现状态总结

### 7.1 已完成的修改 ✅

#### 7.1.1 后端修改 ✅ 已完成
- ✅ 修改 `app/core/config.py` - 添加用户配置支持
- ✅ 修改 `app/services/dashscope_service.py` - 支持动态模型切换
- ✅ 修改 `app/services/duplicate_detection_service.py` - 支持动态阈值调整
- ✅ 修改 `app/api/search.py` - 支持动态相似度阈值
- ✅ 创建 `app/api/config.py` - 实现完整的配置管理API
- ✅ 添加 `/api/v1/config/defaults` 接口 - 支持动态默认值读取

#### 7.1.2 前端修改 ✅ 已完成
- ✅ 修改 `static/js/app-data.js` - 使用配置参数
- ✅ 修改 `static/js/app-photos.js` - 使用配置参数
- ✅ 创建 `static/js/user-config-manager.js` - 完整的配置管理前端逻辑
- ✅ 创建 `templates/settings.html` - 用户配置管理页面
- ✅ 实现动态默认值显示功能

#### 7.1.3 配置文件修改 ✅ 已完成
- ✅ 更新 `config.json` - 添加所有用户配置项
- ✅ 创建 `config_default.json` - 提供默认配置模板
- ✅ 实现配置重置功能

### 7.2 核心功能实现 ✅

#### 7.2.1 动态默认值读取 ✅ 已实现
- **问题**：配置页面默认值硬编码在HTML中，与 `config_default.json` 不一致
- **解决方案**：添加 `/api/v1/config/defaults` 接口，前端动态加载默认值
- **效果**：修改 `config_default.json` 后，刷新页面即可看到新的默认值

#### 7.2.2 配置管理API ✅ 已实现
- 用户配置获取/更新/重置
- 默认配置获取
- 可用模型列表获取
- 目录/文件选择对话框
- 配置导出/重新加载

#### 7.2.3 前端配置界面 ✅ 已实现
- 完整的配置管理页面
- 实时配置值显示
- 动态默认值显示
- 配置保存/重置功能

## 八、实现完成总结

### 8.1 实现完成状态 ✅ 全部完成

**第一阶段：后端配置支持** ✅ 已完成
1. ✅ 修改 `app/core/config.py` 添加用户配置支持
2. ✅ 修改相关服务使用配置参数（DashScope、重复检测、搜索）
3. ✅ 创建 `app/api/config.py` 实现配置管理API
4. ✅ 更新 `config.json` 添加新配置项

**第二阶段：前端配置界面** ✅ 已完成
1. ✅ 创建 `templates/settings.html` 用户配置页面
2. ✅ 创建 `static/js/user-config-manager.js` 配置管理逻辑
3. ✅ 修改现有前端代码使用配置参数
4. ✅ 集成到主应用导航

**第三阶段：测试和优化** ✅ 已完成
1. ✅ 测试用户配置加载和保存
2. ✅ 测试环境变量优先级（特别是DashScope API密钥）
3. ✅ 测试配置参数的实际效果
4. ✅ 优化用户体验和界面

### 8.2 新增功能亮点

#### 8.2.1 动态默认值读取 ✅ 新增功能
- **问题解决**：彻底解决了配置页面默认值硬编码的问题
- **技术实现**：通过 `/api/v1/config/defaults` 接口动态读取 `config_default.json`
- **用户体验**：修改默认配置后无需重启服务，刷新页面即可生效

#### 8.2.2 完整的配置管理API ✅ 新增功能
- 7个配置管理API接口全部实现
- 支持用户配置和高级配置两个层次

---

**文档版本**：V2.0
**最后更新**：2025年9月17日
**文档状态**：草稿

**更新说明**：
- 更新技术栈描述，反映实际使用的Pydantic配置框架
- 完善配置加载流程，基于实际实现
- 更新API接口数量，确认7个接口全部实现
- 补充动态默认值读取功能的实现细节
- 增加配置验证和错误处理说明
- 更新用户界面和交互设计内容
- 提供目录/文件选择对话框功能

## 九、总结

### 9.1 两层次配置管理特点
- **用户界面配置**：简洁直观，只暴露用户真正需要的参数
- **高级配置**：开发者通过直接编辑 `config.json` 进行深度调试
- **安全可靠**：敏感信息通过环境变量管理
- **易于维护**：配置文件结构清晰，向后兼容

### 9.2 用户配置参数统计
- **AI服务设置**：2个参数（模型选择、API密钥）
- **存储设置**：5个参数（存储路径、缩略图质量/尺寸、照片大小限制）
- **界面设置**：4个参数（显示数量相关）
- **搜索设置**：2个参数（相似度阈值、重复检测阈值）
- **总计**：13个用户可配置参数

### 9.3 实现结果
- **实现状态**：✅ 全部完成
- **实际用时**：1天完成核心功能
- **技术方案**：基于现有配置系统扩展，无重构风险
- **功能完整**：超出原设计，新增动态默认值读取功能

---

**文档结束**

*本文档版本：V4.0*  
*最后更新：2025年1月19日*  
*文档状态：☑ 草稿 □ 评审中 □ 已确认 □ 已归档*

