[9 tools called]

## ğŸ“‹ **å¯¼å…¥ç…§ç‰‡è¿›åº¦æ¡è·Ÿè¸ªå…·ä½“å®ç°æ–¹æ¡ˆ**

ç»è¿‡ä»”ç»†é˜…è¯»ä»£ç ï¼Œæˆ‘å·²ç»å®Œå…¨ç†è§£äº†å¯¼å…¥ç…§ç‰‡åŠŸèƒ½çš„è¿›åº¦æ¡è·Ÿè¸ªæœºåˆ¶ã€‚

### ğŸ”„ **ä¸¤ä¸ªæ­¥éª¤çš„å…·ä½“å®ç°**

#### **ç¬¬ä¸€æ­¥ï¼šæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨**
```javascript
// API: POST /api/v1/import/upload
// å‰ç«¯ä½¿ç”¨XMLHttpRequestç›‘å¬ä¸Šä¼ è¿›åº¦

const xhr = new XMLHttpRequest();

// ç›‘å¬ä¸Šä¼ è¿›åº¦äº‹ä»¶
xhr.upload.addEventListener('progress', (event) => {
    if (event.lengthComputable) {
        const percentComplete = Math.round((event.loaded / event.total) * 100);
        
        // æ›´æ–°è¿›åº¦æ¡
        elements.importProgressBar.style.width = `${percentComplete}%`;
        
        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        elements.importStatus.textContent = `æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶... ${percentComplete}%`;
    }
});

// å‘é€æ–‡ä»¶
xhr.open('POST', `${CONFIG.API_BASE_URL}/import/upload`);
xhr.send(formData);
```

**ç‰¹ç‚¹**ï¼š
- âœ… **å®æ—¶å­—èŠ‚çº§è¿›åº¦**ï¼šåŸºäº `event.loaded / event.total`
- âœ… **æµè§ˆå™¨åŸç”Ÿæ”¯æŒ**ï¼šXMLHttpRequestçš„progressäº‹ä»¶
- âœ… **ç²¾ç¡®åˆ°1%**ï¼šé¿å…é¢‘ç¹æ›´æ–°ï¼ˆå˜åŒ–â‰¥1%æ‰æ›´æ–°ï¼‰

#### **ç¬¬äºŒæ­¥ï¼šä¸Šä¼ åçš„åå°å¤„ç†**
```javascript
// API: GET /api/v1/import/scan-status/{task_id}
// å‰ç«¯å®šæ—¶è½®è¯¢çŠ¶æ€

function monitorImportProgress(taskId, totalFiles) {
    const progressInterval = setInterval(async () => {
        const response = await fetch(`${CONFIG.API_BASE_URL}/import/scan-status/${taskId}`);
        const statusData = await response.json();
        
        // æ›´æ–°è¿›åº¦æ¡
        const progress = statusData.progress_percentage || 0;
        elements.importProgressBar.style.width = `${progress}%`;
        
        // æ›´æ–°è¯¦ç»†çŠ¶æ€
        elements.importStatus.textContent = `æ­£åœ¨å¤„ç†: ${statusData.processed_files || 0}/${totalFiles} (${progress}%) - å·²å¯¼å…¥: ${statusData.imported_count || 0}, è·³è¿‡: ${statusData.skipped_count || 0}, å¤±è´¥: ${statusData.failed_count || 0}`;
        
        // æ£€æŸ¥å®Œæˆ
        if (statusData.status === 'completed') {
            clearInterval(progressInterval);
            showImportDetails(statusData);
        }
    }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
}
```

### ğŸ“¡ **APIæ¥å£è¯¦æƒ…**

#### **1. ä¸Šä¼ æ¥å£** (`POST /api/v1/import/upload`)
```javascript
// åç«¯å®ç°
@router.post("/upload")
async def upload_photos(files: List[UploadFile] = File(...)):
    # ç”Ÿæˆä»»åŠ¡ID
    task_id = str(uuid.uuid4())
    
    # æ·»åŠ åå°ä»»åŠ¡å¤„ç†
    background_tasks.add_task(
        process_photos_batch_with_status_from_upload, 
        files, db, task_id
    )
    
    # ç«‹å³è¿”å›ä»»åŠ¡IDï¼ˆHTTP 202ï¼‰
    return {
        "success": True,
        "data": {
            "task_id": task_id,
            "total_files": len(files)
        }
    }
```

#### **2. çŠ¶æ€æŸ¥è¯¢æ¥å£** (`GET /api/v1/import/scan-status/{task_id}`)
```javascript
// åç«¯å®ç°
@router.get("/scan-status/{task_id}")
async def get_scan_status(task_id: str):
    return task_status[task_id]  # è¿”å›çŠ¶æ€å­—å…¸
```

#### **çŠ¶æ€æ•°æ®ç»“æ„**ï¼š
```javascript
{
    "status": "processing", // æˆ– "completed", "failed"
    "total_files": 5,
    "processed_files": 3,
    "imported_count": 3,
    "skipped_count": 0,
    "failed_count": 0,
    "failed_files": [],
    "progress_percentage": 60
}
```

### ğŸ”„ **åç«¯çŠ¶æ€æ›´æ–°æœºåˆ¶**

```python
# åœ¨åå°ä»»åŠ¡ä¸­å®æ—¶æ›´æ–°çŠ¶æ€
async def process_photos_batch_with_status_from_upload(files, db, task_id):
    # åˆå§‹åŒ–çŠ¶æ€
    task_status[task_id] = {
        "status": "processing",
        "progress_percentage": 0,
        # ... å…¶ä»–å­—æ®µ
    }
    
    # å¤„ç†æ¯ä¸ªæ–‡ä»¶åæ›´æ–°è¿›åº¦
    for i, file in enumerate(files):
        # å¤„ç†æ–‡ä»¶...
        
        # æ›´æ–°çŠ¶æ€ï¼ˆæ¯ä¸ªæ–‡ä»¶å¤„ç†å®Œéƒ½æ›´æ–°ï¼‰
        task_status[task_id]["processed_files"] = i + 1
        task_status[task_id]["progress_percentage"] = int((i + 1) / len(files) * 100)
        task_status[task_id]["imported_count"] = imported_count
        # ... æ›´æ–°å…¶ä»–è®¡æ•°å™¨
```

### ğŸ¯ **è¿›åº¦æ¡è¿ç»­æ€§è®¾è®¡**

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šä¸Šä¼ è¿›åº¦ 0% â†’ 100%
2. **è¿‡æ¸¡é˜¶æ®µ**ï¼šæ˜¾ç¤º"ä¸Šä¼ å®Œæˆï¼Œåå°æ­£åœ¨å¤„ç†..."
3. **ç¬¬äºŒé˜¶æ®µ**ï¼šå¤„ç†è¿›åº¦ 0% â†’ 100%ï¼ˆç»§ç»­ä½¿ç”¨åŒä¸€è¿›åº¦æ¡ï¼‰

**è¿›åº¦æ¡è§†è§‰æ•ˆæœ**ï¼š
```
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] æ­£åœ¨ä¸Šä¼  3 ä¸ªæ–‡ä»¶... 60%
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] ä¸Šä¼ å®Œæˆï¼Œåå°æ­£åœ¨å¤„ç† 3 ä¸ªæ–‡ä»¶...
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] æ­£åœ¨å¤„ç†: 1/3 (33%) - å·²å¯¼å…¥: 1, è·³è¿‡: 0, å¤±è´¥: 0
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] æ­£åœ¨å¤„ç†: 3/3 (100%) - å·²å¯¼å…¥: 3, è·³è¿‡: 0, å¤±è´¥: 0
```

### ğŸš€ **æŠ€æœ¯ç‰¹ç‚¹**

- **åŒé‡è¿›åº¦è·Ÿè¸ª**ï¼šä¸Šä¼ ç”¨æµè§ˆå™¨äº‹ä»¶ï¼Œå¤„ç†ç”¨APIè½®è¯¢
- **æ— ç¼è¡”æ¥**ï¼šä¸¤ä¸ªé˜¶æ®µä½¿ç”¨åŒä¸€è¿›åº¦æ¡å…ƒç´ 
- **è¯¦ç»†çŠ¶æ€åé¦ˆ**ï¼šä¸ä»…æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œè¿˜æ˜¾ç¤ºå…·ä½“æ•°é‡
- **å®¹é”™è®¾è®¡**ï¼šç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶ç­‰éƒ½æœ‰å¤„ç†é€»è¾‘
- **å®æ—¶åŒæ­¥**ï¼šå‰ç«¯æ¯500msè·å–æœ€æ–°çŠ¶æ€

è¿™ä¸ªå®ç°ç¡®ä¿äº†ç”¨æˆ·åœ¨æ•´ä¸ªå¯¼å…¥è¿‡ç¨‹ä¸­éƒ½èƒ½çœ‹åˆ°æ¸…æ™°ã€å‡†ç¡®çš„è¿›åº¦åé¦ˆï¼ ğŸ‰