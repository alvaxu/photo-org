# 家庭版智能照片系统 - 开发环境搭建指南

## 一、文档基础信息

| 项目名称 | 家庭版智能照片系统 | 文档类型 | 开发环境搭建指南 |
| -------- | ------------------------- | -------- | ---------------- |
| 文档版本 | V1.0 | 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 |
| 编写人 | AI助手 | 编写日期 | 2025年9月9日 |
| 适用对象 | 开发人员、测试人员 | | |

## 二、环境要求

### 2.1 硬件要求

#### 2.1.1 最低配置
- **处理器**：Intel Core i5 或 AMD Ryzen 5 及以上
- **内存**：8GB RAM 及以上
- **硬盘**：100GB 可用存储空间（推荐SSD）
- **网络**：稳定的网络连接（用于AI分析和依赖下载）

#### 2.1.2 推荐配置
- **处理器**：Intel Core i7 或 AMD Ryzen 7 及以上
- **内存**：16GB RAM 及以上
- **硬盘**：256GB SSD 及以上
- **网络**：高速网络连接

### 2.2 软件要求

#### 2.2.1 操作系统
- **Windows**：Windows 10 版本 1903 及以上，或 Windows 11
- **macOS**：macOS 10.15 (Catalina) 及以上
- **Linux**：Ubuntu 18.04 LTS 及以上，CentOS 7 及以上

#### 2.2.2 Python环境
- **Python版本**：Python 3.8 至 Python 3.11
- **包管理器**：pip 20.0+ 或 conda 4.8+

#### 2.2.3 开发工具
- **代码编辑器**：Visual Studio Code、PyCharm 或其他支持Python的IDE
- **版本控制**：Git 2.25+
- **数据库工具**：SQLite Browser 或 DBeaver（可选）

## 三、开发环境搭建

### 3.1 Python环境安装

#### 3.1.1 Windows环境

1. **下载Python安装包**
   - 访问 https://www.python.org/downloads/
   - 下载 Python 3.8+ 版本
   - 选择 "Windows installer (64-bit)"

2. **安装Python**
   - 运行安装程序
   - 勾选 "Add Python to PATH"
   - 选择 "Install Now"
   - 等待安装完成

3. **验证安装**
   ```bash
   python --version
   pip --version
   ```

#### 3.1.2 macOS环境

1. **使用Homebrew安装**
   ```bash
   # 安装Homebrew（如果未安装）
   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
   
   # 安装Python
   brew install python@3.9
   ```

2. **使用官方安装包**
   - 访问 https://www.python.org/downloads/
   - 下载 macOS 版本
   - 运行安装程序

3. **验证安装**
   ```bash
   python3 --version
   pip3 --version
   ```

#### 3.1.3 Linux环境

1. **Ubuntu/Debian**
   ```bash
   # 更新包列表
   sudo apt update
   
   # 安装Python
   sudo apt install python3 python3-pip python3-venv
   
   # 验证安装
   python3 --version
   pip3 --version
   ```

2. **CentOS/RHEL**
   ```bash
   # 启用EPEL仓库
   sudo yum install epel-release
   
   # 安装Python
   sudo yum install python38 python38-pip
   
   # 验证安装
   python3.8 --version
   pip3.8 --version
   ```

### 3.2 项目代码获取

#### 3.2.1 克隆项目
```bash
# 克隆项目代码
git clone <项目仓库地址>
cd photos_org

# 查看项目结构
ls -la
```

#### 3.2.2 创建虚拟环境
```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS/Linux
python3 -m venv venv
source venv/bin/activate

# 验证虚拟环境
which python
which pip
```

### 3.3 依赖包安装

#### 3.3.1 安装项目依赖
```bash
# 激活虚拟环境（如果未激活）
# Windows: venv\Scripts\activate
# macOS/Linux: source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

#### 3.3.2 手动安装依赖（备选方案）
如果没有requirements.txt文件，可以手动安装主要依赖：

```bash
# 核心依赖
pip install fastapi uvicorn
pip install sqlalchemy
pip install pillow opencv-python
pip install dashscope

# 开发依赖
pip install pytest black flake8 mypy

# 可选依赖
pip install python-multipart
pip install aiofiles
```

#### 3.3.3 验证依赖安装
```bash
# 检查关键包是否安装成功
python -c "import fastapi; print('FastAPI:', fastapi.__version__)"
python -c "import sqlalchemy; print('SQLAlchemy:', sqlalchemy.__version__)"
python -c "import PIL; print('Pillow:', PIL.__version__)"
python -c "import cv2; print('OpenCV:', cv2.__version__)"
```

### 3.4 数据库初始化

#### 3.4.1 创建数据目录
```bash
# 创建数据存储目录
mkdir -p data
mkdir -p photos_storage/originals
mkdir -p photos_storage/thumbnails
mkdir -p photos_storage/temp
mkdir -p photos_storage/backups
mkdir -p logs
```

#### 3.4.2 初始化数据库
```bash
# 运行数据库初始化脚本
python scripts/init_database.py

# 或者手动创建数据库文件
python -c "import sqlite3; conn = sqlite3.connect('data/photos.db'); conn.close()"
```

### 3.5 配置文件设置

#### 3.5.1 配置文件说明
系统使用 `config.json` 作为主配置文件，`config.default.json` 作为默认配置模板。

#### 3.5.2 编辑配置文件
编辑项目根目录下的 `config.json` 文件：

```json
{
  "database": {
    "path": "./data/photos.db"
  },
  "dashscope": {
    "api_key": "your_dashscope_api_key_here",
    "base_url": "https://dashscope.aliyuncs.com/api/v1"
  },
  "storage": {
    "base_path": "./photos_storage",
    "originals_path": "originals",
    "thumbnails_path": "thumbnails",
    "temp_path": "temp",
    "max_file_size": 52428800,
    "thumbnail_size": 300,
    "thumbnail_quality": 85
  },
  "analysis": {
    "max_concurrent": 2,
    "timeout": 10,
    "max_file_size": 52428800,
    "duplicate_threshold": 5
  },
  "logging": {
    "level": "INFO",
    "file_path": "./logs/app.log",
    "max_size": "10MB",
    "backup_count": 5
  }
}
```

#### 3.5.3 设置API密钥
1. 访问 https://dashscope.aliyuncs.com/
2. 注册账号并获取API Key
3. 将API Key填入配置文件中的 `dashscope.api_key` 字段

或者使用环境变量：
```bash
# Windows
set DASHSCOPE_API_KEY=your_api_key_here

# macOS/Linux
export DASHSCOPE_API_KEY=your_api_key_here
```

### 3.6 开发工具配置

#### 3.6.1 Visual Studio Code配置

1. **安装Python扩展**
   - 打开VS Code
   - 按 `Ctrl+Shift+P` (Windows/Linux) 或 `Cmd+Shift+P` (macOS)
   - 输入 "Python: Select Interpreter"
   - 选择项目虚拟环境的Python解释器

2. **配置settings.json**
   ```json
   {
     "python.pythonPath": "./venv/bin/python",
     "python.linting.enabled": true,
     "python.linting.flake8Enabled": true,
     "python.formatting.provider": "black",
     "editor.formatOnSave": true,
     "python.testing.pytestEnabled": true
   }
   ```

#### 3.6.2 PyCharm配置

1. **设置Python解释器**
   - 打开PyCharm
   - File → Settings → Project → Python Interpreter
   - 点击齿轮图标 → Add
   - 选择 "Virtualenv Environment"
   - 选择项目中的 `venv` 目录

2. **配置代码风格**
   - File → Settings → Editor → Code Style → Python
   - 设置代码风格为 Black

### 3.7 运行和测试

#### 3.7.1 启动开发服务器
```bash
# 激活虚拟环境
# Windows: venv\Scripts\activate
# macOS/Linux: source venv/bin/activate

# 启动开发服务器
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 3.7.2 访问应用
- Web界面：http://localhost:8000
- API文档：http://localhost:8000/docs
- API交互界面：http://localhost:8000/redoc

#### 3.7.3 运行测试
```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_photos.py

# 运行带覆盖率测试
pytest --cov=app --cov-report=html
```

### 3.8 代码质量检查

#### 3.8.1 代码格式化
```bash
# 使用Black格式化代码
black .

# 使用flake8检查代码风格
flake8 .

# 使用mypy进行类型检查
mypy .
```

#### 3.8.2 自动修复
```bash
# 自动修复导入排序
isort .

# 自动修复常见问题
autoflake --remove-all-unused-imports --remove-unused-variables --in-place .
```

## 四、常见问题解决

### 4.1 Python安装问题

#### 4.1.1 pip安装失败
```bash
# 升级pip
python -m pip install --upgrade pip

# 使用国内源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple package-name
```

#### 4.1.2 虚拟环境问题
```bash
# 删除并重新创建虚拟环境
rm -rf venv
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或 venv\Scripts\activate  # Windows
```

### 4.2 依赖包安装问题

#### 4.2.1 OpenCV安装失败
```bash
# 使用预编译版本
pip install opencv-python-headless

# 或使用系统包
# Ubuntu/Debian
sudo apt install python3-opencv
```

#### 4.2.2 网络问题
```bash
# 设置pip国内源
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 或使用阿里云源
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
```

### 4.3 数据库问题

#### 4.3.1 数据库文件权限问题
```bash
# 检查文件权限
ls -la data/photos.db

# 修复权限
chmod 644 data/photos.db
```

#### 4.3.2 数据库版本问题
```bash
# 检查SQLite版本
python -c "import sqlite3; print(sqlite3.sqlite_version)"

# 如果版本太低，升级SQLite
# Ubuntu/Debian
sudo apt install sqlite3
```

### 4.4 API调用问题

#### 4.4.1 API密钥问题
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY

# 或检查配置文件
cat config/config.json | grep api_key
```

#### 4.4.2 网络连接问题
```bash
# 测试网络连接
curl -I https://dashscope.aliyuncs.com/api/v1

# 检查防火墙设置
# Windows: 控制面板 -> Windows Defender 防火墙
# Linux: sudo ufw status
```

## 五、开发工作流

### 5.1 代码开发流程

1. **创建功能分支**
   ```bash
   git checkout -b feature/new-feature
   ```

2. **编写代码**
   - 遵循代码规范
   - 添加必要的注释
   - 编写单元测试

3. **代码检查**
   ```bash
   # 格式化代码
   black .
   flake8 .
   
   # 运行测试
   pytest
   ```

4. **提交代码**
   ```bash
   git add .
   git commit -m "feat: 添加新功能"
   git push origin feature/new-feature
   ```

5. **创建Pull Request**
   - 在GitHub上创建PR
   - 等待代码审查
   - 合并到主分支

### 5.2 调试技巧

#### 5.2.1 使用调试器
```python
# 在代码中添加断点
import pdb; pdb.set_trace()

# 或使用VS Code调试器
# 在代码中设置断点，然后按F5启动调试
```

#### 5.2.2 日志调试
```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# 在关键位置添加日志
logger.debug("处理照片: %s", photo_path)
logger.info("分析完成，耗时: %.2f秒", processing_time)
```

#### 5.2.3 API调试
- 使用Postman或Insomnia测试API
- 查看API文档中的示例
- 检查请求头和响应格式

## 六、部署准备

### 6.1 生产环境配置

#### 6.1.1 配置文件调整
```json
{
  "logging": {
    "level": "WARNING"
  },
  "analysis": {
    "max_concurrent": 3
  }
}
```

#### 6.1.2 性能优化
```bash
# 安装生产WSGI服务器
pip install gunicorn

# 启动生产服务器
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 6.2 监控和日志

#### 6.2.1 设置日志轮转
```python
import logging
from logging.handlers import RotatingFileHandler

# 设置日志轮转
handler = RotatingFileHandler(
    'logs/app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)
```

#### 6.2.2 性能监控
```bash
# 使用内存分析器
pip install memory-profiler
python -m memory_profiler app/main.py

# 使用代码分析器
pip install line-profiler
```

## 七、团队协作

### 7.1 代码规范

#### 7.1.1 提交信息规范
```bash
# 格式: <类型>(<范围>): <简短描述>
git commit -m "feat(auth): 添加用户登录功能"

# 类型包括:
# feat: 新功能
# fix: 修复bug
# docs: 文档更新
# style: 代码格式
# refactor: 重构
# test: 测试
# chore: 构建/工具
```

#### 7.1.2 分支管理
```bash
# 主分支
git branch main

# 开发分支
git branch develop

# 功能分支
git checkout -b feature/user-login

# 修复分支
git checkout -b bugfix/login-error

# 发布分支
git checkout -b release/v1.0.0
```

### 7.2 文档维护

#### 7.2.1 更新文档
- 新功能开发时同步更新相关文档
- API变更时更新API文档
- 配置变更时更新配置文档

#### 7.2.2 文档审查
- 代码审查时包含文档审查
- 确保文档与代码保持同步
- 定期审查和更新过时文档

## 八、总结

通过遵循本开发环境搭建指南，开发人员可以快速搭建完整的开发环境，包括：

**环境搭建**：
- Python环境安装和配置
- 项目代码获取和虚拟环境创建
- 依赖包安装和管理
- 数据库和配置文件初始化

**开发工具**：
- VS Code和PyCharm配置
- 代码质量检查工具
- 测试和调试工具

**开发流程**：
- 代码开发和版本控制
- 代码质量保证
- 团队协作规范

**问题解决**：
- 常见安装和配置问题
- 调试技巧和方法

---

**文档版本**：V2.0
**最后更新**：2025年9月17日
**文档状态**：草稿

**更新说明**：
- 更新Python版本要求，从3.8+确认具体版本
- 完善依赖包列表，基于实际requirements.txt
- 更新环境搭建步骤，反映实际的部署流程
- 补充开发工具配置，增加VS Code和PyCharm设置
- 增加代码质量保证和团队协作规范
- 更新常见问题解决方法和调试技巧
- 性能优化建议

按照本指南搭建的开发环境将为项目的顺利开发提供坚实的基础，确保开发过程的高效和规范。
