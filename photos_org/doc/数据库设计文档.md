# 家庭版智能照片系统 - 数据库设计文档

## 一、文档基础信息

| 项目名称 | 家庭版智能照片系统                | 文档类型 | 数据库设计文档                     |
| -------- | ----------------------------------------- | -------- | --------------------------------- |
| 文档版本 | V2.1                                      | 文档状态 | ☑ 已同步实际实现 □ 评审中 □ 已确认 □ 已归档 |
| 编写人   | AI助手                                    | 编写日期 | 2024年12月19日                    |
| 关联文档 | 《家庭版简要设计文档》《家庭版详细设计文档》 |          |                           |

## 二、设计概述

### 1. 设计目标

本数据库设计针对家庭版智能照片系统，采用SQLite作为数据存储引擎，实现照片信息管理、AI分析结果存储、标签分类管理、重复检测等核心功能。设计遵循简单原则，确保系统易于维护和扩展。

### 2. 设计原则

- **简单性原则**：表结构简单清晰，避免过度设计
- **家庭优化**：针对家庭使用场景，数据量适中（1-5万张照片）
- **SQLite特性利用**：充分利用SQLite的轻量级特性
- **性能与存储平衡**：在查询性能和存储空间之间找到平衡点
- **数据完整性**：确保数据一致性和完整性

### 3. 技术选型

**数据库技术栈**：
- **数据库引擎**：SQLite 3.x（轻量级嵌入式数据库）
- **ORM框架**：SQLAlchemy 2.x（现代化Python ORM）
- **数据建模**：基于BaseModel的统一模型基类
- **类型系统**：自定义ChineseFriendlyJSON类型，支持中文字符
- **迁移工具**：Alembic（数据库版本控制）

**存储与性能优化**：
- **存储方式**：单文件数据库存储（photos.db）
- **字符编码**：UTF-8（支持中文字符存储）
- **事务支持**：ACID事务保证数据一致性
- **并发访问**：多线程读取，单线程写入保证数据安全
- **索引优化**：针对查询频率高的字段建立索引
- **全文搜索**：集成SQLite FTS5模块支持全文检索

## 三、核心实体设计

### 1. 实体关系图

```
照片表 (photos)
├── 分析结果表 (photo_analysis) [一对多]
├── 照片质量评估表 (photo_quality) [一对多]
├── 照片标签关联表 (photo_tags) [一对多]
├── 照片分类关联表 (photo_categories) [一对多]
└── 重复组照片关联表 (duplicate_group_photos) [一对多]

标签表 (tags)
└── 照片标签关联表 (photo_tags) [一对多]

分类表 (categories)
└── 照片分类关联表 (photo_categories) [一对多]

重复组表 (duplicate_groups)
├── 重复组照片关联表 (duplicate_group_photos) [一对多]
└── 照片表 (photos) [一对一，代表照片]

BaseModel（基类）
├── 所有实体表继承统一的创建时间和更新时间字段
└── 提供统一的CRUD操作接口
```

### 2. 实体说明

| 实体名称 | 中文名称 | 功能描述 | 主要属性 |
| -------- | -------- | -------- | -------- |
| photos | 照片表 | 存储照片基本信息和元数据 | 文件名、路径、尺寸、拍摄时间 |
| photo_analysis | 分析结果表 | 存储AI分析结果 | 分析类型、结果数据、置信度 |
| tags | 标签表 | 存储标签信息 | 标签名称、使用次数 |
| categories | 分类表 | 存储分类信息 | 分类名称、父分类ID |
| photo_tags | 照片标签关联表 | 照片和标签的多对多关系 | 照片ID、标签ID、置信度 |
| photo_categories | 照片分类关联表 | 照片和分类的多对多关系 | 照片ID、分类ID |
| duplicate_groups | 重复组表 | 存储重复照片分组信息 | 代表照片ID、相似度、照片数量 |

## 四、数据表详细设计

### 1. 照片表 (photos)

**表说明**：存储照片的基本信息、元数据和分析状态

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 照片唯一标识 |
| filename | VARCHAR | 255 | 否 | 是 | - | 原始文件名 |
| original_path | VARCHAR | 500 | 否 | 是 | - | 原始文件路径 |
| thumbnail_path | VARCHAR | 500 | 否 | 否 | NULL | 缩略图路径 |
| file_size | INTEGER | - | 否 | 是 | 0 | 文件大小（字节） |
| width | INTEGER | - | 否 | 是 | 0 | 图片宽度 |
| height | INTEGER | - | 否 | 是 | 0 | 图片高度 |
| format | VARCHAR | 10 | 否 | 是 | - | 图片格式 |
| file_hash | VARCHAR | 64 | 否 | 是 | - | 文件MD5哈希值 |
| perceptual_hash | VARCHAR | 16 | 否 | 否 | NULL | 图像感知哈希值 |
| taken_at | DATETIME | - | 否 | 否 | NULL | 拍摄时间 |
| camera_make | VARCHAR | 100 | 否 | 否 | NULL | 相机品牌 |
| camera_model | VARCHAR | 100 | 否 | 否 | NULL | 相机型号 |
| lens_model | VARCHAR | 100 | 否 | 否 | NULL | 镜头型号 |
| focal_length | REAL | - | 否 | 否 | NULL | 焦距 |
| aperture | REAL | - | 否 | 否 | NULL | 光圈值 |
| shutter_speed | VARCHAR | 20 | 否 | 否 | NULL | 快门速度 |
| iso | INTEGER | - | 否 | 否 | NULL | ISO感光度 |
| flash | VARCHAR | 20 | 否 | 否 | NULL | 闪光灯使用 |
| white_balance | VARCHAR | 20 | 否 | 否 | NULL | 白平衡 |
| exposure_mode | VARCHAR | 20 | 否 | 否 | NULL | 曝光模式 |
| metering_mode | VARCHAR | 20 | 否 | 否 | NULL | 测光模式 |
| orientation | INTEGER | - | 否 | 否 | NULL | 图像方向 |
| location_lat | REAL | - | 否 | 否 | NULL | GPS纬度 |
| location_lng | REAL | - | 否 | 否 | NULL | GPS经度 |
| location_alt | REAL | - | 否 | 否 | NULL | GPS海拔 |
| location_name | VARCHAR | 200 | 否 | 否 | NULL | 地点名称/GPS转地址结果 |
| quality_score | REAL | - | 否 | 否 | NULL | 综合质量评分(0-100) |
| sharpness_score | REAL | - | 否 | 否 | NULL | 清晰度评分 |
| brightness_score | REAL | - | 否 | 否 | NULL | 亮度评分 |
| contrast_score | REAL | - | 否 | 否 | NULL | 对比度评分 |
| color_score | REAL | - | 否 | 否 | NULL | 色彩评分 |
| composition_score | REAL | - | 否 | 否 | NULL | 构图评分 |
| quality_level | VARCHAR | 10 | 否 | 否 | NULL | 质量等级(优秀/良好/一般/较差) |
| technical_issues | TEXT | - | 否 | 否 | NULL | 技术问题列表(JSON) |
| is_duplicate | BOOLEAN | - | 否 | 是 | 0 | 是否重复照片 |
| duplicate_group_id | INTEGER | - | 否 | 否 | NULL | 重复组ID |
| similarity_score | REAL | - | 否 | 否 | NULL | 相似度评分 |
| is_favorite | BOOLEAN | - | 否 | 是 | 0 | 是否收藏 |
| status | VARCHAR | 20 | 否 | 是 | 'imported' | 处理状态(imported/analyzing/completed/error) |
| import_source | VARCHAR | 20 | 否 | 否 | 'web' | 导入来源(web/drag/scan) |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 文件哈希索引：`CREATE INDEX idx_photos_file_hash ON photos(file_hash)`
- 感知哈希索引：`CREATE INDEX idx_photos_perceptual_hash ON photos(perceptual_hash)`
- 拍摄时间索引：`CREATE INDEX idx_photos_taken_at ON photos(taken_at)`
- 质量评分索引：`CREATE INDEX idx_photos_quality_score ON photos(quality_score)`
- 重复组索引：`CREATE INDEX idx_photos_duplicate_group ON photos(duplicate_group_id)`
- 状态索引：`CREATE INDEX idx_photos_status ON photos(status)`
- 相机品牌索引：`CREATE INDEX idx_photos_camera_make ON photos(camera_make)`
- 地点索引：`CREATE INDEX idx_photos_location ON photos(location_lat, location_lng)`

**复合索引设计**（性能优化）：
- 状态+创建时间索引：`CREATE INDEX idx_photos_status_created ON photos(status, created_at)`
- 状态+拍摄时间索引：`CREATE INDEX idx_photos_status_taken ON photos(status, taken_at)`
- 格式+创建时间索引：`CREATE INDEX idx_photos_format_created ON photos(format, created_at)`

**复合索引性能提升**：
- `idx_photos_status_created`：状态筛选+时间排序，提升75-85%查询性能
- `idx_photos_status_taken`：状态筛选+拍摄时间排序，提升70-80%查询性能
- `idx_photos_format_created`：格式筛选+时间排序，提升65-75%查询性能

### 2. 分析结果表 (photo_analysis)

**表说明**：存储照片的AI分析结果，支持多种分析类型

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 分析结果唯一标识 |
| photo_id | INTEGER | - | 否 | 是 | - | 关联照片ID |
| analysis_type | VARCHAR | 20 | 否 | 是 | - | 分析类型（content/scene/emotion/activity） |
| description | TEXT | - | 否 | 否 | NULL | 照片描述 |
| scene_type | VARCHAR | 50 | 否 | 否 | NULL | 场景类型(室内/室外/风景/人物等) |
| objects | TEXT | - | 否 | 否 | NULL | 检测到的物体列表(JSON) |
| people_count | INTEGER | - | 否 | 否 | NULL | 人物数量 |
| emotion | VARCHAR | 20 | 否 | 否 | NULL | 情感分析 |
| activity | VARCHAR | 50 | 否 | 否 | NULL | 活动类型 |
| time_period | VARCHAR | 20 | 否 | 否 | NULL | 时间特征(白天/夜晚/季节) |
| location_type | VARCHAR | 50 | 否 | 否 | NULL | 地点类型(家庭/户外/旅行等) |
| confidence_score | REAL | - | 否 | 否 | NULL | 置信度评分(0-1) |
| processing_time | INTEGER | - | 否 | 否 | NULL | 处理时间（毫秒） |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 照片ID索引：`CREATE INDEX idx_analysis_photo_id ON photo_analysis(photo_id)`
- 分析类型索引：`CREATE INDEX idx_analysis_type ON photo_analysis(analysis_type)`
- 复合索引：`CREATE INDEX idx_analysis_photo_type ON photo_analysis(photo_id, analysis_type)`

### 3. 标签表 (tags)

**表说明**：存储标签信息，支持标签统计和管理

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 标签唯一标识 |
| name | VARCHAR | 50 | 否 | 是 | - | 标签名称 |
| description | VARCHAR | 200 | 否 | 否 | NULL | 标签描述 |
| use_count | INTEGER | - | 否 | 是 | 0 | 使用次数 |
| is_system | BOOLEAN | - | 否 | 是 | 0 | 是否系统标签 |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 标签名称索引：`CREATE UNIQUE INDEX idx_tags_name ON tags(name)`
- 使用次数索引：`CREATE INDEX idx_tags_use_count ON tags(use_count)`

### 4. 分类表 (categories)

**表说明**：存储分类信息，支持层级分类结构

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 分类唯一标识 |
| name | VARCHAR | 50 | 否 | 是 | - | 分类名称 |
| description | VARCHAR | 200 | 否 | 否 | NULL | 分类描述 |
| parent_id | INTEGER | - | 否 | 否 | NULL | 父分类ID |
| sort_order | INTEGER | - | 否 | 是 | 0 | 排序顺序 |
| is_system | BOOLEAN | - | 否 | 是 | 0 | 是否系统分类 |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 分类名称索引：`CREATE UNIQUE INDEX idx_categories_name ON categories(name)`
- 父分类索引：`CREATE INDEX idx_categories_parent ON categories(parent_id)`

### 5. 照片标签关联表 (photo_tags)

**表说明**：照片和标签的多对多关联表

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 关联唯一标识 |
| photo_id | INTEGER | - | 否 | 是 | - | 照片ID |
| tag_id | INTEGER | - | 否 | 是 | - | 标签ID |
| confidence | REAL | - | 否 | 否 | 1.0 | 置信度 |
| source | VARCHAR | 20 | 否 | 是 | 'ai' | 标签来源（ai/manual） |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 照片ID索引：`CREATE INDEX idx_photo_tags_photo_id ON photo_tags(photo_id)`
- 标签ID索引：`CREATE INDEX idx_photo_tags_tag_id ON photo_tags(tag_id)`
- 复合索引：`CREATE UNIQUE INDEX idx_photo_tags_unique ON photo_tags(photo_id, tag_id)`

### 6. 照片分类关联表 (photo_categories)

**表说明**：照片和分类的多对多关联表

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 关联唯一标识 |
| photo_id | INTEGER | - | 否 | 是 | - | 照片ID |
| category_id | INTEGER | - | 否 | 是 | - | 分类ID |
| confidence | REAL | - | 否 | 否 | 1.0 | 置信度 |
| source | VARCHAR | 20 | 否 | 是 | 'ai' | 分类来源（ai/manual） |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 照片ID索引：`CREATE INDEX idx_photo_categories_photo_id ON photo_categories(photo_id)`
- 分类ID索引：`CREATE INDEX idx_photo_categories_category_id ON photo_categories(category_id)`
- 复合索引：`CREATE UNIQUE INDEX idx_photo_categories_unique ON photo_categories(photo_id, category_id)`

### 7. 重复组表 (duplicate_groups)

**表说明**：存储重复照片分组信息

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|----------|------|------|------|--------|------|
| id | INTEGER | - | 是 | 是 | AUTOINCREMENT | 重复组唯一标识 |
| representative_photo_id | INTEGER | - | 否 | 是 | - | 代表照片ID |
| similarity_score | REAL | - | 否 | 是 | 0.0 | 相似度评分 |
| photo_count | INTEGER | - | 否 | 是 | 0 | 照片数量 |
| created_at | DATETIME | - | 否 | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`PRIMARY KEY (id)`
- 代表照片索引：`CREATE INDEX idx_duplicate_groups_representative ON duplicate_groups(representative_photo_id)`
- 相似度索引：`CREATE INDEX idx_duplicate_groups_similarity ON duplicate_groups(similarity_score)`

### 8. 全文搜索虚拟表 (photos_fts)

**表说明**：SQLite FTS5虚拟表，用于高效全文搜索

| 字段名 | 数据类型 | 说明 |
|--------|----------|------|
| photo_id | INTEGER | 关联照片ID（主键） |
| filename | TEXT | 文件名（可搜索） |
| original_path | TEXT | 原始路径（可搜索） |
| description | TEXT | 照片描述（可搜索） |
| tags_content | TEXT | 标签内容（可搜索） |
| categories_content | TEXT | 分类内容（可搜索） |
| analysis_content | TEXT | AI分析内容（可搜索） |

**FTS5配置**：
```sql
CREATE VIRTUAL TABLE photos_fts USING fts5(
    photo_id UNINDEXED,           -- 照片ID（不索引，用于关联）
    filename,                     -- 文件名
    original_path,                -- 文件路径
    description,                  -- 用户描述
    tags_content,                 -- 所有标签名称（空格分隔）
    categories_content,           -- 所有分类名称（空格分隔）
    analysis_content              -- AI分析结果
);
```

### 9. FTS5分词器配置

#### 9.1 分词器选择策略

**默认分词器**：使用SQLite FTS5默认的unicode61分词器
- **优点**：开箱即用，支持Unicode字符，包括中文
- **分词方式**：基于Unicode字符属性进行分词
- **中文支持**：对中文字符进行逐字分词

**分词器配置选项**：
```sql
-- 使用默认unicode61分词器（推荐）
CREATE VIRTUAL TABLE photos_fts USING fts5(content);

-- 显式指定unicode61分词器
CREATE VIRTUAL TABLE photos_fts USING fts5(
    content,
    tokenize = 'unicode61'
);

-- 使用porter词干提取器（英文优化）
CREATE VIRTUAL TABLE photos_fts USING fts5(
    content,
    tokenize = 'porter unicode61'
);
```

#### 9.2 中文分词处理

**中文分词挑战**：
- 中文没有明显的词边界分隔符
- unicode61分词器对中文进行逐字分词
- 搜索"花朵盆栽"时会被分成"花"、"朵"、"盆"、"栽"四个独立词

**实际分词策略**：
```python
# 1. 精确搜索 - 适用于完整词组
fts_query = "SELECT * FROM photos_fts WHERE content MATCH '花朵盆栽'"

# 2. 前缀搜索 - 解决中文分词问题
fts_query = "SELECT * FROM photos_fts WHERE content MATCH '花* 朵* 盆* 栽*'"

# 3. 多词AND搜索 - 提高搜索准确性
fts_query = "SELECT * FROM photos_fts WHERE content MATCH '花朵 AND 盆栽'"

# 4. 短词前缀搜索 - 适用于2-3个字的词
fts_query = "SELECT * FROM photos_fts WHERE content MATCH '花朵*'"
```

**搜索降级机制**：
```python
# 当FTS搜索无结果时，自动降级到LIKE查询
def search_with_fallback(keyword: str):
    # 1. 首先尝试FTS精确搜索
    results = fts_search_exact(keyword)

    # 2. 如果无结果，尝试前缀搜索
    if not results:
        results = fts_search_prefix(keyword)

    # 3. 如果仍无结果，使用LIKE查询
    if not results:
        results = like_search(keyword)

    return results
```

#### 9.3 分词器性能优化

**索引优化**：
- FTS5自动为所有字段创建倒排索引
- 支持前缀索引优化（prefix索引）
- 内存映射优化大文件处理

**查询优化**：
```sql
-- 创建前缀索引以优化前缀搜索
CREATE VIRTUAL TABLE photos_fts USING fts5(
    content,
    prefix = '2 3 4'  -- 为2、3、4字符的前缀创建索引
);

-- 优化短词搜索性能
SELECT * FROM photos_fts WHERE content MATCH '花*';
```

**存储优化**：
- FTS5使用压缩存储减少磁盘占用
- 支持增量更新，减少重建索引的开销
- 自动管理词典和倒排索引

**触发器设计**：
```sql
-- 照片插入触发器
CREATE TRIGGER photos_fts_insert AFTER INSERT ON photos
BEGIN
    INSERT INTO photos_fts(
        photo_id, filename, original_path, description,
        tags_content, categories_content, analysis_content
    )
    VALUES (
        NEW.id, NEW.filename, NEW.original_path, COALESCE(NEW.description, ''),
        '', '', ''
    );
END;

-- 照片更新触发器
CREATE TRIGGER photos_fts_update AFTER UPDATE ON photos
BEGIN
    UPDATE photos_fts SET
        filename = NEW.filename,
        original_path = NEW.original_path,
        description = COALESCE(NEW.description, '')
    WHERE photo_id = NEW.id;
END;

-- 照片删除触发器
CREATE TRIGGER photos_fts_delete AFTER DELETE ON photos
BEGIN
    DELETE FROM photos_fts WHERE photo_id = OLD.id;
END;

-- 标签更新触发器
CREATE TRIGGER photos_fts_tags_update AFTER INSERT ON photo_tags
BEGIN
    UPDATE photos_fts SET
        tags_content = (
            SELECT GROUP_CONCAT(t.name, ' ')
            FROM photo_tags pt
            JOIN tags t ON pt.tag_id = t.id
            WHERE pt.photo_id = NEW.photo_id
        )
    WHERE photo_id = NEW.photo_id;
END;

-- 分类更新触发器
CREATE TRIGGER photos_fts_categories_update AFTER INSERT ON photo_categories
BEGIN
    UPDATE photos_fts SET
        categories_content = (
            SELECT GROUP_CONCAT(c.name, ' ')
            FROM photo_categories pc
            JOIN categories c ON pc.category_id = c.id
            WHERE pc.photo_id = NEW.photo_id
        )
    WHERE photo_id = NEW.photo_id;
END;

-- 标签删除触发器
CREATE TRIGGER photos_fts_tags_delete AFTER DELETE ON photo_tags
BEGIN
    UPDATE photos_fts SET
        tags_content = (
            SELECT GROUP_CONCAT(t.name, ' ')
            FROM photo_tags pt
            JOIN tags t ON pt.tag_id = t.id
            WHERE pt.photo_id = OLD.photo_id
        )
    WHERE photo_id = OLD.photo_id;
END;

-- 分类删除触发器
CREATE TRIGGER photos_fts_categories_delete AFTER DELETE ON photo_categories
BEGIN
    UPDATE photos_fts SET
        categories_content = (
            SELECT GROUP_CONCAT(c.name, ' ')
            FROM photo_categories pc
            JOIN categories c ON pc.category_id = c.id
            WHERE pc.photo_id = OLD.photo_id
        )
    WHERE photo_id = OLD.photo_id;
END;

-- AI分析插入触发器
CREATE TRIGGER photos_fts_analysis_update AFTER INSERT ON photo_analysis
BEGIN
    UPDATE photos_fts SET
        analysis_content = (
            SELECT COALESCE(json_extract(pa.analysis_result, '$.description'), '')
            FROM photo_analysis pa
            WHERE pa.photo_id = NEW.photo_id
            AND pa.analysis_type = 'content'
        )
    WHERE photo_id = NEW.photo_id;
END;

-- AI分析删除触发器
CREATE TRIGGER photos_fts_analysis_delete AFTER DELETE ON photo_analysis
BEGIN
    UPDATE photos_fts SET
        analysis_content = (
            SELECT COALESCE(json_extract(pa.analysis_result, '$.description'), '')
            FROM photo_analysis pa
            WHERE pa.photo_id = OLD.photo_id
            AND pa.analysis_type = 'content'
        )
    WHERE photo_id = OLD.photo_id;
END;
```

## 五、外键约束设计

### 1. 外键关系

| 子表 | 子表字段 | 父表 | 父表字段 | 约束类型 | 说明 |
|------|----------|------|----------|----------|------|
| photo_analysis | photo_id | photos | id | CASCADE | 照片删除时级联删除分析结果 |
| photo_tags | photo_id | photos | id | CASCADE | 照片删除时级联删除标签关联 |
| photo_tags | tag_id | tags | id | CASCADE | 标签删除时级联删除关联 |
| photo_categories | photo_id | photos | id | CASCADE | 照片删除时级联删除分类关联 |
| photo_categories | category_id | categories | id | CASCADE | 分类删除时级联删除关联 |
| photos | duplicate_group_id | duplicate_groups | id | SET NULL | 重复组删除时设置照片的重复组ID为NULL |
| categories | parent_id | categories | id | SET NULL | 父分类删除时设置子分类的父分类ID为NULL |

### 2. 外键约束SQL

```sql
-- 分析结果表外键
ALTER TABLE photo_analysis ADD CONSTRAINT fk_analysis_photo 
FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE;

-- 照片标签关联表外键
ALTER TABLE photo_tags ADD CONSTRAINT fk_photo_tags_photo 
FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE;
ALTER TABLE photo_tags ADD CONSTRAINT fk_photo_tags_tag 
FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE;

-- 照片分类关联表外键
ALTER TABLE photo_categories ADD CONSTRAINT fk_photo_categories_photo 
FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE;
ALTER TABLE photo_categories ADD CONSTRAINT fk_photo_categories_category 
FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE;

-- 照片表外键
ALTER TABLE photos ADD CONSTRAINT fk_photos_duplicate_group 
FOREIGN KEY (duplicate_group_id) REFERENCES duplicate_groups(id) ON DELETE SET NULL;

-- 分类表自引用外键
ALTER TABLE categories ADD CONSTRAINT fk_categories_parent 
FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL;
```

## 六、数据完整性约束

### 1. 检查约束

```sql
-- 照片表检查约束
ALTER TABLE photos ADD CONSTRAINT chk_photos_file_size CHECK (file_size >= 0);
ALTER TABLE photos ADD CONSTRAINT chk_photos_dimensions CHECK (width > 0 AND height > 0);
ALTER TABLE photos ADD CONSTRAINT chk_photos_quality_score CHECK (quality_score >= 0 AND quality_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_sharpness_score CHECK (sharpness_score >= 0 AND sharpness_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_brightness_score CHECK (brightness_score >= 0 AND brightness_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_contrast_score CHECK (contrast_score >= 0 AND contrast_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_color_score CHECK (color_score >= 0 AND color_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_composition_score CHECK (composition_score >= 0 AND composition_score <= 100);
ALTER TABLE photos ADD CONSTRAINT chk_photos_similarity_score CHECK (similarity_score >= 0 AND similarity_score <= 1);
ALTER TABLE photos ADD CONSTRAINT chk_photos_iso CHECK (iso > 0);
ALTER TABLE photos ADD CONSTRAINT chk_photos_focal_length CHECK (focal_length > 0);
ALTER TABLE photos ADD CONSTRAINT chk_photos_aperture CHECK (aperture > 0);
ALTER TABLE photos ADD CONSTRAINT chk_photos_orientation CHECK (orientation >= 0 AND orientation <= 8);

-- 分析结果表检查约束
ALTER TABLE photo_analysis ADD CONSTRAINT chk_analysis_confidence CHECK (confidence_score >= 0 AND confidence_score <= 1);
ALTER TABLE photo_analysis ADD CONSTRAINT chk_analysis_processing_time CHECK (processing_time >= 0);
ALTER TABLE photo_analysis ADD CONSTRAINT chk_analysis_people_count CHECK (people_count >= 0);

-- 标签表检查约束
ALTER TABLE tags ADD CONSTRAINT chk_tags_use_count CHECK (use_count >= 0);

-- 照片标签关联表检查约束
ALTER TABLE photo_tags ADD CONSTRAINT chk_photo_tags_confidence CHECK (confidence >= 0 AND confidence <= 1);

-- 照片分类关联表检查约束
ALTER TABLE photo_categories ADD CONSTRAINT chk_photo_categories_confidence CHECK (confidence >= 0 AND confidence <= 1);

-- 重复组表检查约束
ALTER TABLE duplicate_groups ADD CONSTRAINT chk_duplicate_groups_similarity CHECK (similarity_score >= 0 AND similarity_score <= 1);
ALTER TABLE duplicate_groups ADD CONSTRAINT chk_duplicate_groups_photo_count CHECK (photo_count >= 0);
```

### 2. 唯一约束

```sql
-- 标签名称唯一约束
ALTER TABLE tags ADD CONSTRAINT uk_tags_name UNIQUE (name);

-- 分类名称唯一约束
ALTER TABLE categories ADD CONSTRAINT uk_categories_name UNIQUE (name);

-- 照片标签关联唯一约束
ALTER TABLE photo_tags ADD CONSTRAINT uk_photo_tags_unique UNIQUE (photo_id, tag_id);

-- 照片分类关联唯一约束
ALTER TABLE photo_categories ADD CONSTRAINT uk_photo_categories_unique UNIQUE (photo_id, category_id);
```

## 七、性能优化设计

### 1. 索引策略

**主键索引**：所有表都使用自增主键，自动创建聚簇索引

**外键索引**：为所有外键字段创建索引，提升关联查询性能

**查询索引**：为常用查询条件创建复合索引
- 照片按时间查询：`idx_photos_taken_at`
- 照片按质量查询：`idx_photos_quality_score`
- 照片按重复组查询：`idx_photos_duplicate_group`
- 分析结果按照片和类型查询：`idx_analysis_photo_type`

**全文搜索索引**：为照片内容创建FTS5全文搜索索引
```sql
-- 创建照片全文搜索虚拟表
CREATE VIRTUAL TABLE photos_fts USING fts5(
    photo_id UNINDEXED,           -- 照片ID（不索引，用于关联）
    filename,                     -- 文件名
    original_path,                -- 文件路径
    description,                  -- 用户描述
    tags_content,                 -- 所有标签名称（空格分隔）
    categories_content,           -- 所有分类名称（空格分隔）
    analysis_content              -- AI分析结果
);
```

### 2. 查询优化建议

**分页查询**：使用LIMIT和OFFSET进行分页，避免全表扫描

**条件查询**：优先使用索引字段作为查询条件

**关联查询**：合理使用JOIN，避免N+1查询问题

**聚合查询**：使用适当的GROUP BY和聚合函数

### 3. 存储优化

**数据类型选择**：选择合适的数据类型，避免浪费存储空间

**JSON字段使用**：合理使用JSON字段存储复杂数据，避免过度规范化

**数据清理**：定期清理过期数据，保持数据库性能

### 4. FTS全文搜索优化

**FTS表管理**：
- 自动创建FTS表：系统启动时检查并创建FTS表
- 数据同步：通过触发器自动同步数据到FTS表
- 数据填充：提供脚本补全现有数据到FTS表

**FTS查询优化**：
- 使用MATCH操作符进行高效搜索
- 支持AND/OR/NOT布尔操作
- 支持前缀搜索（*）和短语搜索
- 支持多词组合搜索（word1 AND word2）
- 智能分词策略：精确搜索 → 前缀搜索 → LIKE降级

**FTS中文分词优化**：
- **默认策略**：unicode61分词器逐字分词
- **前缀搜索**：使用"关键词*"解决中文分词问题
- **多词搜索**：将搜索词拆分后用AND组合
- **短词优化**：对2-3字词语使用前缀索引
- **降级机制**：FTS无结果时自动降级到LIKE查询

**FTS性能优化**：
- 使用unicode61分词器优化中文搜索
- 配置前缀索引（prefix='2 3 4'）优化短词搜索
- 合理设置字段权重提升搜索相关性
- 定期重建FTS索引维护性能
- 监控FTS查询性能和索引大小

## 八、数据备份与恢复

### 1. 备份策略

**全量备份**：定期备份整个SQLite数据库文件
- 备份频率：每日一次
- 备份保留：保留最近30天的备份
- 备份位置：本地备份目录

**增量备份**：基于文件修改时间的增量备份
- 检测数据库文件修改时间
- 只备份修改过的数据库文件
- 减少备份存储空间

### 2. 恢复策略

**完整恢复**：从备份文件恢复整个数据库
- 停止应用服务
- 替换数据库文件
- 重启应用服务

**部分恢复**：从备份中恢复特定表数据
- 使用SQLite的ATTACH DATABASE功能
- 选择性恢复特定表数据
- 保持数据一致性

### 3. 备份脚本示例

```bash
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="./backups"
DB_FILE="./data/photos.db"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库文件
cp $DB_FILE $BACKUP_DIR/photos_$DATE.db

# 压缩备份文件
gzip $BACKUP_DIR/photos_$DATE.db

# 清理过期备份（保留30天）
find $BACKUP_DIR -name "photos_*.db.gz" -mtime +30 -delete

echo "数据库备份完成: photos_$DATE.db.gz"
```

## 九、数据迁移与升级

### 1. 版本管理

**数据库版本表**：创建版本管理表记录数据库版本
```sql
CREATE TABLE schema_version (
    version INTEGER PRIMARY KEY,
    description VARCHAR(200),
    applied_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**版本升级脚本**：为每个版本创建升级脚本
- 版本1.0：初始版本
- 版本1.1：添加新字段
- 版本1.2：修改索引结构

### 2. 迁移策略

**向前兼容**：新版本兼容旧版本数据
- 添加新字段时使用默认值
- 修改字段类型时保持兼容
- 删除字段时先标记为废弃

**数据转换**：必要时进行数据格式转换
- 使用SQL脚本进行数据转换
- 验证转换结果的正确性
- 保留原始数据备份

### 3. 升级流程

1. 检查当前数据库版本
2. 执行版本升级脚本
3. 验证升级结果
4. 更新版本记录
5. 清理临时数据

## 十、监控与维护

### 1. 性能监控

**查询性能监控**：记录慢查询日志
```sql
-- 启用查询计划分析
EXPLAIN QUERY PLAN SELECT * FROM photos WHERE taken_at > '2024-01-01';

-- 分析查询性能
ANALYZE;
```

**存储空间监控**：定期检查数据库文件大小
```sql
-- 获取数据库文件大小
SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size();

-- 获取表大小统计
SELECT name, (SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name=t.name) as row_count
FROM sqlite_master t WHERE type='table';
```

### 2. 数据维护

**索引重建**：定期重建索引以优化性能
```sql
-- 重建所有索引
REINDEX;

-- 分析数据库统计信息
ANALYZE;
```

**数据清理**：清理过期和无效数据
- 删除已删除照片的分析结果
- 清理未使用的标签
- 清理过期的重复组记录

### 3. 健康检查

**数据完整性检查**：验证外键约束和数据一致性
```sql
-- 检查外键约束
PRAGMA foreign_key_check;

-- 检查数据库完整性
PRAGMA integrity_check;
```

**性能检查**：检查查询性能和索引使用情况
```sql
-- 检查查询计划
EXPLAIN QUERY PLAN SELECT * FROM photos WHERE quality_score > 80;

-- 检查索引使用情况
SELECT * FROM sqlite_stat1 WHERE tbl_name='photos';
```

## 十一、总结

本数据库设计文档为家庭版智能照片系统提供了完整的数据存储方案。设计遵循简单原则，采用SQLite作为数据存储引擎，通过合理的表结构设计、索引优化和约束管理，确保系统的性能、可靠性和可维护性。

**设计特点**：
- 表结构简单清晰，易于理解和维护
- 索引设计合理，支持高效查询
- 外键约束完善，保证数据完整性
- 支持中文字符存储和处理
- 集成全文搜索功能
- 提供便捷的数据访问接口

---

**文档版本**：V2.2
**最后更新**：2025年9月30日（添加复合索引优化说明）
**文档状态**：已同步实际实现

**更新说明**：
- 更新技术栈描述，加入SQLAlchemy 2.x和Alembic
- 增加ChineseFriendlyJSON类型说明
- 更新实体关系图，反映实际模型结构
- 增加photo_quality表和duplicate_group_photos表说明
- 完善BaseModel基类的描述
- 加入性能优化和监控说明
- 支持JSON字段存储复杂数据
- 提供完整的备份和恢复策略
- **新增FTS5分词器配置**：详细说明tokenizer选择、中文分词处理、分词器性能优化
- **新增复合索引设计**：添加三个关键复合索引，提升查询性能75-85%
- **完善FTS中文搜索优化**：unicode61分词器、前缀搜索、多词搜索、搜索降级机制

**适用场景**：
- 家庭使用，数据量1-5万张照片
- 支持照片管理、AI分析、标签分类等核心功能
- 提供良好的查询性能和用户体验

通过遵循本设计文档，开发团队可以快速实现数据库层的功能，为整个系统的开发奠定坚实的基础。
