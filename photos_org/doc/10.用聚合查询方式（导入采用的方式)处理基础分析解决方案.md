# åŸºç¡€åˆ†æåˆ†æ‰¹å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆï¼šä¿®å¤batch-status APIæ¶æ„ç¼ºé™·

## é—®é¢˜èƒŒæ™¯

åœ¨å®æ–½èšåˆæŸ¥è¯¢æ–¹æ¡ˆåï¼Œå‘ç°åŸºç¡€åˆ†æçš„batch-status APIå­˜åœ¨ä¸¥é‡æ¶æ„ç¼ºé™·ï¼Œå¯¼è‡´ï¼š

1. **å‰ç«¯æ°¸è¿œè®¤ä¸ºä»»åŠ¡æœªå®Œæˆ**ï¼šAPIå§‹ç»ˆè¿”å›0ä¸ªå®Œæˆæ‰¹æ¬¡
2. **æŒç»­ç›‘æ§ç›´åˆ°è¶…æ—¶**ï¼šå‰ç«¯ç›‘æ§20åˆ†é’Ÿååœæ­¢ï¼Œä½†åˆ†æä»»åŠ¡ä»åœ¨åå°è¿è¡Œ
3. **é‡å¤åˆ†æé£é™©**ï¼šç”¨æˆ·å†æ¬¡è§¦å‘æ—¶å¯èƒ½é‡å¤åˆ†æå·²å¤„ç†ç…§ç‰‡

## æ ¹æœ¬åŸå› 

åˆ†ææ¨¡å—ç¼ºå°‘ç±»ä¼¼å¯¼å…¥æ¨¡å—çš„ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªæœºåˆ¶ï¼š

- âœ… **å¯¼å…¥æ¨¡å—**ï¼šä½¿ç”¨`task_status`å­—å…¸è·Ÿè¸ªæ¯ä¸ªæ‰¹æ¬¡çŠ¶æ€
- âŒ **åˆ†ææ¨¡å—**ï¼šå®Œå…¨ä¾èµ–æ•°æ®åº“å…¨å±€ç»Ÿè®¡ï¼Œæ— æ³•åŒºåˆ†æ‰¹æ¬¡

```python
# é”™è¯¯å®ç°ï¼šä½¿ç”¨å…¨å±€analyzing_count
if analyzing_count == 0:  # æ°¸è¿œä¸ºfalse
    status = "completed"
```

## è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªæœºåˆ¶

```python
# å…¨å±€åˆ†æä»»åŠ¡çŠ¶æ€è·Ÿè¸ªï¼ˆç±»ä¼¼å¯¼å…¥æ¨¡å—çš„task_statusï¼‰
analysis_task_status = {}

# ä»»åŠ¡çŠ¶æ€æ¸…ç†é…ç½®
TASK_STATUS_CLEANUP_HOURS = 1
```

### 2. ä¿®æ”¹process_analysis_taskå‡½æ•°

åœ¨ä»»åŠ¡å¼€å§‹ã€å¤„ç†è¿‡ç¨‹å’Œå®Œæˆæ—¶æ›´æ–°çŠ¶æ€ï¼š

```python
# åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
analysis_task_status[task_id] = {
    "status": "processing",
    "total_photos": len(photo_ids),
    "completed_photos": 0,
    "failed_photos": 0,
    "progress_percentage": 0.0,
    "start_time": datetime.now().isoformat(),
    "analysis_types": analysis_types
}

# å¤„ç†è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°
analysis_task_status[task_id]["completed_photos"] = successful_analyses
analysis_task_status[task_id]["progress_percentage"] = (successful_analyses / len(photo_ids)) * 100

# å®Œæˆæ—¶æ ‡è®°å®Œæˆ
analysis_task_status[task_id].update({
    "status": "completed",
    "end_time": datetime.now().isoformat(),
    "progress_percentage": 100.0
})

# å»¶è¿Ÿæ¸…ç†ä»»åŠ¡çŠ¶æ€
asyncio.create_task(cleanup_task_status())
```

### 3. é‡å†™batch-status API

ä½¿ç”¨ä»»åŠ¡çŠ¶æ€å­—å…¸è€Œä¸æ˜¯å…¨å±€æ•°æ®åº“ç»Ÿè®¡ï¼š

```python
# ä»ä»»åŠ¡çŠ¶æ€å­—å…¸è·å–ä»»åŠ¡çŠ¶æ€
task_data = analysis_task_status.get(task_id)
if task_data:
    status = task_data["status"]
    completed_photos = task_data["completed_photos"]
    # ... ä½¿ç”¨å‡†ç¡®çš„ä»»åŠ¡çŠ¶æ€
```

## ä¿®å¤æ•ˆæœ

### âœ… è§£å†³çš„é—®é¢˜

1. **å‡†ç¡®çš„çŠ¶æ€åˆ¤æ–­**ï¼šæ¯ä¸ªæ‰¹æ¬¡ç‹¬ç«‹çŠ¶æ€è·Ÿè¸ª
2. **å®æ—¶è¿›åº¦æ›´æ–°**ï¼šå‰ç«¯èƒ½çœ‹åˆ°å‡†ç¡®çš„å¤„ç†è¿›åº¦
3. **æ­£ç¡®çš„å®Œæˆæ£€æµ‹**ï¼šä»»åŠ¡å®Œæˆåå‰ç«¯èƒ½æ­£ç¡®è¯†åˆ«
4. **é¿å…é‡å¤åˆ†æ**ï¼šé˜²æ­¢é‡å¤è§¦å‘åŒä¸€æ‰¹æ¬¡

### ğŸ“Š å¯¹æ¯”æ•ˆæœ

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| çŠ¶æ€å‡†ç¡®æ€§ | å…¨å±€ç»Ÿè®¡æ··æ·† | æ‰¹æ¬¡çº§ç²¾ç¡®è·Ÿè¸ª |
| è¿›åº¦æ˜¾ç¤º | å§‹ç»ˆæ˜¾ç¤º0% | å®æ—¶å‡†ç¡®è¿›åº¦ |
| å®Œæˆæ£€æµ‹ | æ°¸è¿œprocessing | æ­£ç¡®completed |
| ç›‘æ§æ—¶é•¿ | 20åˆ†é’Ÿè¶…æ—¶ | ä»»åŠ¡å®Œæˆåç«‹å³åœæ­¢ |
| é‡å¤åˆ†æ | å¯èƒ½é‡å¤ | é¿å…é‡å¤ |

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶
- `app/api/analysis.py`: æ·»åŠ çŠ¶æ€è·Ÿè¸ªå’Œä¿®å¤batch-status API

### æ–°å¢åŠŸèƒ½
1. **ä»»åŠ¡çŠ¶æ€å­—å…¸**ï¼š`analysis_task_status`
2. **çŠ¶æ€æ›´æ–°æœºåˆ¶**ï¼šä»»åŠ¡ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è·Ÿè¸ª
3. **å†…å­˜æ¸…ç†æœºåˆ¶**ï¼šé˜²æ­¢å†…å­˜æ³„æ¼
4. **ç²¾ç¡®æ‰¹æ¬¡åŒºåˆ†**ï¼šæ¯ä¸ªæ‰¹æ¬¡ç‹¬ç«‹çŠ¶æ€

### å…¼å®¹æ€§ä¿è¯
- ä¿æŒAPIæ¥å£ä¸å˜
- ä¸å½±å“ç°æœ‰åŠŸèƒ½
- å‘åå…¼å®¹æ—§ç‰ˆæœ¬

## æµ‹è¯•éªŒè¯

é€šè¿‡æµ‹è¯•è„šæœ¬éªŒè¯çŠ¶æ€è·Ÿè¸ªåŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

```
ğŸ§ª æµ‹è¯•åˆ†æä»»åŠ¡çŠ¶æ€è·Ÿè¸ªåŠŸèƒ½
ğŸ“ åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€: test-task-123
ğŸ”„ æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹...
20.0% 40.0% 60.0% 80.0% 100.0%
âœ… ä»»åŠ¡å®Œæˆ: {'status': 'completed', 'total_photos': 5, ...}
ğŸ‰ ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªæµ‹è¯•é€šè¿‡ï¼
```

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†åŸºç¡€åˆ†æåˆ†æ‰¹å¤„ç†çš„æ ¹æœ¬æ¶æ„é—®é¢˜ï¼Œç¡®ä¿ï¼š

1. **å‰ç«¯èƒ½å‡†ç¡®äº†è§£ä»»åŠ¡çŠ¶æ€**
2. **é¿å…ä¸å¿…è¦çš„é•¿æ—¶é—´ç›‘æ§**
3. **é˜²æ­¢é‡å¤åˆ†æ**
4. **æä¾›å‡†ç¡®çš„è¿›åº¦åé¦ˆ**

æ–¹æ¡ˆé‡‡ç”¨ç±»ä¼¼å¯¼å…¥æ¨¡å—çš„è®¾è®¡æ¨¡å¼ï¼Œä¿è¯äº†ç³»ç»Ÿçš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚
