# 家庭单机版智能照片整理系统 - 搜索检索模块详细设计文档

## 一、文档基础信息

| 项目名称 | 家庭单机版智能照片整理系统 | 文档类型 | 搜索检索模块详细设计文档 |
| -------- | ------------------------- | -------- | ----------------------- |
| 文档版本 | V1.0 | 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 |
| 编写人 | AI助手 | 编写日期 | 2025年9月9日 |
| 关联文档 | 《家庭单机版简要设计文档》《数据库设计文档》《智能分析模块详细设计文档》 | | |

## 二、模块概述

### 2.1 模块目标

搜索检索模块是家庭照片整理系统的核心交互模块，负责为用户提供多维度、智能化的照片搜索和检索功能。通过整合数据库中的丰富元数据，支持关键词搜索、条件筛选、智能推荐等多种搜索方式，帮助用户快速找到所需的照片。

### 2.2 设计原则

- **简单易用**：搜索界面简洁直观，操作简单
- **响应快速**：搜索响应时间 ≤ 2秒
- **结果准确**：搜索准确率 ≥ 90%
- **功能完整**：支持多种搜索方式和组合条件
- **家庭优化**：单用户家庭使用，简化搜索体验

### 2.3 技术选型

- **全文搜索**：SQLite FTS5
- **索引优化**：复合索引、覆盖索引
- **搜索算法**：模糊匹配、相似度计算
- **前端技术**：HTML5 + CSS3 + JavaScript
- **后端框架**：FastAPI + SQLAlchemy

## 三、搜索需求分析

### 3.1 用户搜索场景

基于家庭照片整理的特点，用户的主要搜索场景包括：

#### 3.1.1 时间相关搜索
- **具体时间**："2023年12月的照片"
- **相对时间**："最近一周的照片"
- **季节搜索**："夏天的照片"
- **节日搜索**："春节的照片"

#### 3.1.2 内容相关搜索
- **人物搜索**："有人的照片"、"全家福"
- **场景搜索**："室内照片"、"风景照片"
- **活动搜索**："聚会照片"、"旅行照片"
- **物体搜索**："食物照片"、"宠物照片"

#### 3.1.3 质量相关搜索
- **质量筛选**："最清晰的照片"、"模糊的照片"
- **评分搜索**："质量评分80分以上的照片"
- **问题搜索**："有技术问题的照片"

#### 3.1.4 设备相关搜索
- **设备类型**："用iPhone拍的照片"
- **相机品牌**："用佳能拍的照片"
- **技术参数**："大光圈照片"、"高ISO照片"

#### 3.1.5 位置相关搜索
- **地点名称**："在家拍的照片"、"旅行照片"
- **GPS位置**："在某个区域拍的照片"

### 3.2 搜索方式需求

#### 3.2.1 关键词搜索
- 支持中文关键词搜索
- 支持模糊匹配和部分匹配
- 支持多关键词组合搜索
- 支持排除关键词搜索

#### 3.2.2 条件筛选
- 时间范围筛选
- 质量评分筛选
- 分类标签筛选
- 设备类型筛选
- 文件属性筛选

#### 3.2.3 高级搜索
- 多条件组合搜索
- 复杂逻辑表达式
- 保存搜索条件
- 搜索历史管理

## 四、数据库字段分析

### 4.1 可搜索字段分类

#### 4.1.1 基础信息字段（高可用性）
```sql
-- 文件基础信息（100%可用）
filename, file_size, width, height, format, file_hash
created_at, updated_at, status, import_source

-- 图像基础信息（100%可用）
width, height, format, file_size
```

#### 4.1.2 时间相关字段（中等可用性）
```sql
-- 拍摄时间（约60%可用，取决于EXIF数据）
taken_at

-- 系统时间（100%可用）
created_at, updated_at
```

#### 4.1.3 设备信息字段（低可用性）
```sql
-- 相机信息（约30%可用，取决于EXIF数据）
camera_make, camera_model, lens_model
focal_length, aperture, shutter_speed, iso
flash, white_balance, exposure_mode, metering_mode, orientation
```

#### 4.1.4 位置信息字段（低可用性）
```sql
-- GPS信息（约20%可用，取决于EXIF数据）
location_lat, location_lng, location_alt, location_name
```

#### 4.1.5 质量评估字段（高可用性）
```sql
-- 质量评分（100%可用，通过OpenCV分析）
quality_score, sharpness_score, brightness_score, contrast_score
color_score, composition_score, quality_level, technical_issues
```

#### 4.1.6 AI分析字段（中等可用性）
```sql
-- AI分析结果（约80%可用，取决于AI分析完成情况）
description, scene_type, objects, people_count, emotion
activity, time_period, location_type, confidence_score
```

#### 4.1.7 标签分类字段（中等可用性）
```sql
-- 标签信息（通过关联表，约70%可用）
tags.name, tags.description

-- 分类信息（通过关联表，约70%可用）
categories.name, categories.description
```

### 4.2 搜索优先级设计

#### 4.2.1 高优先级搜索字段
- **基础信息**：filename, created_at, taken_at
- **质量评分**：quality_score, quality_level
- **AI分析**：description, scene_type, objects
- **标签分类**：tags, categories

#### 4.2.2 中优先级搜索字段
- **设备信息**：camera_make, camera_model
- **位置信息**：location_name
- **技术参数**：focal_length, aperture, iso

#### 4.2.3 低优先级搜索字段
- **详细技术参数**：shutter_speed, white_balance等
- **GPS坐标**：location_lat, location_lng

## 五、搜索功能设计

### 5.1 基础搜索功能

#### 5.1.1 关键词搜索
```python
def search_by_keywords(keywords: str, search_fields: List[str] = None) -> List[Photo]:
    """
    关键词搜索
    
    :param keywords: 搜索关键词
    :param search_fields: 搜索字段列表
    :return: 搜索结果列表
    """
    # 支持搜索的字段
    default_fields = [
        'filename', 'description', 'scene_type', 
        'objects', 'activity', 'location_name'
    ]
    
    # 使用FTS5全文搜索
    # 支持模糊匹配和相关性排序
```

#### 5.1.2 时间范围搜索
```python
def search_by_time_range(start_date: datetime, end_date: datetime, 
                        time_field: str = 'taken_at') -> List[Photo]:
    """
    时间范围搜索
    
    :param start_date: 开始时间
    :param end_date: 结束时间
    :param time_field: 时间字段(taken_at/created_at)
    :return: 搜索结果列表
    """
    # 支持多种时间字段搜索
    # 支持相对时间搜索（最近一周、上个月等）
```

#### 5.1.3 质量筛选搜索
```python
def search_by_quality(min_score: float = None, max_score: float = None,
                     quality_level: str = None) -> List[Photo]:
    """
    质量筛选搜索
    
    :param min_score: 最低质量评分
    :param max_score: 最高质量评分
    :param quality_level: 质量等级
    :return: 搜索结果列表
    """
    # 支持质量评分范围搜索
    # 支持质量等级筛选
    # 支持技术问题排除
```

### 5.2 高级搜索功能

#### 5.2.1 多条件组合搜索
```python
def advanced_search(search_conditions: Dict) -> List[Photo]:
    """
    高级搜索
    
    :param search_conditions: 搜索条件字典
    :return: 搜索结果列表
    """
    # 支持多条件AND/OR组合
    # 支持排除条件
    # 支持复杂逻辑表达式
```

#### 5.2.2 相似照片搜索
```python
def search_similar_photos(photo_id: int, similarity_threshold: float = 0.8) -> List[Photo]:
    """
    相似照片搜索
    
    :param photo_id: 参考照片ID
    :param similarity_threshold: 相似度阈值
    :return: 相似照片列表
    """
    # 基于感知哈希计算相似度
    # 支持相似度阈值调整
```

#### 5.2.3 智能推荐搜索
```python
def recommend_photos(photo_id: int, limit: int = 10) -> List[Photo]:
    """
    智能推荐搜索
    
    :param photo_id: 参考照片ID
    :param limit: 推荐数量限制
    :return: 推荐照片列表
    """
    # 基于内容相似度推荐
    # 基于时间相关性推荐
    # 基于用户行为推荐
```

### 5.3 搜索优化功能

#### 5.3.1 搜索建议
```python
def get_search_suggestions(query: str, limit: int = 10) -> List[str]:
    """
    搜索建议
    
    :param query: 查询字符串
    :param limit: 建议数量限制
    :return: 搜索建议列表
    """
    # 基于历史搜索记录
    # 基于标签和分类
    # 基于照片描述
```

#### 5.3.2 搜索历史
```python
def get_search_history(user_id: int = None, limit: int = 20) -> List[Dict]:
    """
    搜索历史
    
    :param user_id: 用户ID
    :param limit: 历史记录数量限制
    :return: 搜索历史列表
    """
    # 保存用户搜索记录
    # 支持搜索历史管理
    # 支持快速重复搜索
```

## 六、搜索算法设计

### 6.1 全文搜索算法

#### 6.1.1 FTS5配置
```sql
-- 创建全文搜索虚拟表
CREATE VIRTUAL TABLE photos_fts USING fts5(
    filename, 
    description,
    scene_type,
    objects,
    activity,
    location_name,
    content='photos', 
    content_rowid='id'
);

-- 创建标签全文搜索虚拟表
CREATE VIRTUAL TABLE tags_fts USING fts5(
    name, 
    description,
    content='tags', 
    content_rowid='id'
);
```

#### 6.1.2 搜索查询优化
```sql
-- 基础关键词搜索
SELECT p.*, rank FROM photos p
JOIN photos_fts fts ON p.id = fts.rowid
WHERE photos_fts MATCH '关键词'
ORDER BY rank;

-- 多字段搜索
SELECT p.*, rank FROM photos p
JOIN photos_fts fts ON p.id = fts.rowid
WHERE photos_fts MATCH 'filename:关键词 OR description:关键词'
ORDER BY rank;
```

### 6.2 相似度计算算法

#### 6.2.1 感知哈希相似度
```python
def calculate_similarity(hash1: str, hash2: str) -> float:
    """
    计算感知哈希相似度
    
    :param hash1: 第一个哈希值
    :param hash2: 第二个哈希值
    :return: 相似度(0-1)
    """
    # 计算汉明距离
    # 转换为相似度分数
    # 支持不同哈希算法
```

#### 6.2.2 内容相似度
```python
def calculate_content_similarity(photo1_id: int, photo2_id: int) -> float:
    """
    计算内容相似度
    
    :param photo1_id: 第一个照片ID
    :param photo2_id: 第二个照片ID
    :return: 相似度(0-1)
    """
    # 基于AI分析结果
    # 基于标签相似度
    # 基于场景类型相似度
```

### 6.3 搜索结果排序算法

#### 6.3.1 相关性排序
```python
def calculate_relevance_score(photo: Photo, query: str) -> float:
    """
    计算相关性分数
    
    :param photo: 照片对象
    :param query: 查询字符串
    :return: 相关性分数
    """
    # 关键词匹配度
    # 字段权重
    # 时间新鲜度
    # 质量评分
```

#### 6.3.2 综合排序
```python
def sort_search_results(photos: List[Photo], sort_by: str = 'relevance') -> List[Photo]:
    """
    搜索结果排序
    
    :param photos: 照片列表
    :param sort_by: 排序方式
    :return: 排序后的照片列表
    """
    # 相关性排序
    # 时间排序
    # 质量排序
    # 自定义排序
```

## 七、数据库索引设计

### 7.1 搜索索引

#### 7.1.1 基础搜索索引
```sql
-- 时间索引
CREATE INDEX idx_photos_taken_at ON photos(taken_at);
CREATE INDEX idx_photos_created_at ON photos(created_at);

-- 质量索引
CREATE INDEX idx_photos_quality_score ON photos(quality_score);
CREATE INDEX idx_photos_quality_level ON photos(quality_level);

-- 状态索引
CREATE INDEX idx_photos_status ON photos(status);
CREATE INDEX idx_photos_is_favorite ON photos(is_favorite);
```

#### 7.1.2 复合搜索索引
```sql
-- 时间+质量复合索引
CREATE INDEX idx_photos_time_quality ON photos(taken_at, quality_score);

-- 状态+质量复合索引
CREATE INDEX idx_photos_status_quality ON photos(status, quality_score);

-- 设备+时间复合索引
CREATE INDEX idx_photos_camera_time ON photos(camera_make, taken_at);
```

#### 7.1.3 覆盖索引
```sql
-- 搜索结果覆盖索引
CREATE INDEX idx_photos_search_cover ON photos(
    id, filename, taken_at, quality_score, 
    scene_type, is_favorite, status
);
```

### 7.2 全文搜索索引

#### 7.2.1 FTS5索引配置
```sql
-- 照片全文搜索索引
CREATE VIRTUAL TABLE photos_fts USING fts5(
    filename, 
    description,
    scene_type,
    objects,
    activity,
    location_name,
    content='photos', 
    content_rowid='id',
    tokenize='unicode61'
);

-- 标签全文搜索索引
CREATE VIRTUAL TABLE tags_fts USING fts5(
    name, 
    description,
    content='tags', 
    content_rowid='id',
    tokenize='unicode61'
);
```

## 八、用户界面设计

### 8.1 搜索界面布局

#### 8.1.1 搜索栏设计
```html
<!-- 主搜索栏 -->
<div class="search-container">
    <input type="text" id="main-search" placeholder="搜索照片..." />
    <button id="search-btn">搜索</button>
    <button id="advanced-search-btn">高级搜索</button>
</div>

<!-- 快速筛选栏 -->
<div class="quick-filters">
    <select id="time-filter">
        <option value="">所有时间</option>
        <option value="today">今天</option>
        <option value="week">本周</option>
        <option value="month">本月</option>
        <option value="year">今年</option>
    </select>
    
    <select id="quality-filter">
        <option value="">所有质量</option>
        <option value="excellent">优秀</option>
        <option value="good">良好</option>
        <option value="fair">一般</option>
        <option value="poor">较差</option>
    </select>
    
    <select id="category-filter">
        <option value="">所有分类</option>
        <option value="indoor">室内</option>
        <option value="outdoor">室外</option>
        <option value="people">人物</option>
        <option value="landscape">风景</option>
    </select>
</div>
```

#### 8.1.2 高级搜索界面
```html
<!-- 高级搜索面板 -->
<div class="advanced-search-panel" id="advanced-search-panel">
    <div class="search-group">
        <label>关键词搜索</label>
        <input type="text" id="keyword-search" placeholder="输入关键词..." />
    </div>
    
    <div class="search-group">
        <label>时间范围</label>
        <input type="date" id="start-date" />
        <span>至</span>
        <input type="date" id="end-date" />
    </div>
    
    <div class="search-group">
        <label>质量评分</label>
        <input type="range" id="quality-range" min="0" max="100" />
        <span id="quality-value">50</span>
    </div>
    
    <div class="search-group">
        <label>设备类型</label>
        <select id="camera-filter">
            <option value="">所有设备</option>
            <option value="iPhone">iPhone</option>
            <option value="Canon">佳能</option>
            <option value="Nikon">尼康</option>
        </select>
    </div>
    
    <div class="search-group">
        <label>标签筛选</label>
        <input type="text" id="tag-search" placeholder="输入标签..." />
    </div>
    
    <div class="search-actions">
        <button id="apply-search">应用搜索</button>
        <button id="reset-search">重置</button>
        <button id="save-search">保存搜索</button>
    </div>
</div>
```

### 8.2 搜索结果展示

#### 8.2.1 搜索结果列表
```html
<!-- 搜索结果容器 -->
<div class="search-results">
    <div class="results-header">
        <span id="results-count">找到 0 张照片</span>
        <div class="sort-options">
            <select id="sort-by">
                <option value="relevance">相关性</option>
                <option value="time">时间</option>
                <option value="quality">质量</option>
                <option value="name">文件名</option>
            </select>
        </div>
    </div>
    
    <div class="results-grid" id="results-grid">
        <!-- 搜索结果项 -->
        <div class="photo-item" data-photo-id="1">
            <img src="thumbnail.jpg" alt="照片缩略图" />
            <div class="photo-info">
                <div class="photo-title">照片标题</div>
                <div class="photo-meta">
                    <span class="photo-date">2023-12-19</span>
                    <span class="photo-quality">质量: 85分</span>
                </div>
                <div class="photo-tags">
                    <span class="tag">家庭</span>
                    <span class="tag">聚会</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="pagination" id="pagination">
        <!-- 分页控件 -->
    </div>
</div>
```

#### 8.2.2 搜索建议
```html
<!-- 搜索建议下拉框 -->
<div class="search-suggestions" id="search-suggestions">
    <div class="suggestion-item">家庭聚会</div>
    <div class="suggestion-item">旅行照片</div>
    <div class="suggestion-item">生日</div>
    <div class="suggestion-item">风景</div>
</div>
```

## 九、API接口设计

### 9.1 搜索接口

#### 9.1.1 基础搜索接口
```python
@router.get("/search")
async def search_photos(
    q: str = None,  # 关键词
    time_range: str = None,  # 时间范围
    quality_min: float = None,  # 最低质量评分
    quality_max: float = None,  # 最高质量评分
    category: str = None,  # 分类
    device: str = None,  # 设备类型
    page: int = 1,  # 页码
    size: int = 20,  # 每页数量
    sort_by: str = "relevance"  # 排序方式
) -> SearchResult:
    """
    搜索照片
    
    :param q: 搜索关键词
    :param time_range: 时间范围
    :param quality_min: 最低质量评分
    :param quality_max: 最高质量评分
    :param category: 分类
    :param device: 设备类型
    :param page: 页码
    :param size: 每页数量
    :param sort_by: 排序方式
    :return: 搜索结果
    """
```

#### 9.1.2 高级搜索接口
```python
@router.post("/search/advanced")
async def advanced_search(
    search_conditions: AdvancedSearchConditions
) -> SearchResult:
    """
    高级搜索
    
    :param search_conditions: 搜索条件
    :return: 搜索结果
    """
```

#### 9.1.3 相似照片搜索接口
```python
@router.get("/search/similar/{photo_id}")
async def search_similar_photos(
    photo_id: int,
    threshold: float = 0.8,
    limit: int = 10
) -> List[Photo]:
    """
    搜索相似照片
    
    :param photo_id: 参考照片ID
    :param threshold: 相似度阈值
    :param limit: 结果数量限制
    :return: 相似照片列表
    """
```

### 9.2 搜索辅助接口

#### 9.2.1 搜索建议接口
```python
@router.get("/search/suggestions")
async def get_search_suggestions(
    query: str,
    limit: int = 10
) -> List[str]:
    """
    获取搜索建议
    
    :param query: 查询字符串
    :param limit: 建议数量限制
    :return: 搜索建议列表
    """
```

#### 9.2.2 搜索历史接口
```python
@router.get("/search/history")
async def get_search_history(
    limit: int = 20
) -> List[SearchHistory]:
    """
    获取搜索历史（单用户）
    
    :param limit: 历史记录数量限制
    :return: 搜索历史列表
    """
```

## 十、性能优化设计

### 10.1 搜索性能优化

#### 10.1.1 索引优化
- **复合索引**：为常用搜索组合创建复合索引
- **覆盖索引**：减少回表查询，提升搜索速度
- **部分索引**：为特定条件创建部分索引

#### 10.1.2 查询优化
- **分页查询**：使用LIMIT和OFFSET进行分页
- **查询缓存**：缓存常用查询结果
- **异步查询**：使用异步查询提升并发性能

#### 10.1.3 结果优化
- **结果预加载**：预加载搜索结果的相关数据
- **懒加载**：图片懒加载，提升页面加载速度
- **结果压缩**：压缩搜索结果，减少网络传输

### 10.2 用户体验优化

#### 10.2.1 搜索响应优化
- **即时搜索**：输入时即时显示搜索结果
- **搜索防抖**：避免频繁搜索请求
- **加载状态**：显示搜索进度和状态

#### 10.2.2 结果展示优化
- **无限滚动**：支持无限滚动加载更多结果
- **结果预览**：鼠标悬停显示照片预览
- **快速操作**：支持快速收藏、删除等操作

## 十一、配置管理

### 11.1 统一配置管理

#### 11.1.1 统一配置参数
```json
{
  "system": {
    "max_file_size": 52428800,
    "timeout": 10,
    "max_concurrent": 2
  },
  "database": {
    "path": "./data/photos.db"
  },
  "analysis": {
    "duplicate_threshold": 5
  }
}
```

### 11.2 搜索配置

#### 11.2.1 搜索参数配置
```json
{
  "search": {
    "default_page_size": 20,
    "max_page_size": 100,
    "search_timeout": 5,
    "suggestion_limit": 10,
    "history_limit": 50,
    "similarity_threshold": 0.8
  }
}
```

#### 11.1.2 索引配置
```json
{
  "indexing": {
    "fts5_tokenize": "unicode61",
    "index_rebuild_interval": 3600,
    "auto_index_update": true,
    "index_optimization": true
  }
}
```

### 11.2 搜索规则配置

#### 11.2.1 搜索字段权重
```json
{
  "search_weights": {
    "filename": 1.0,
    "description": 0.8,
    "scene_type": 0.6,
    "objects": 0.4,
    "activity": 0.4,
    "location_name": 0.3
  }
}
```

#### 11.2.2 搜索过滤规则
```json
{
  "search_filters": {
    "exclude_duplicates": false,
    "exclude_low_quality": false,
    "quality_threshold": 0,
    "date_range_limit": 365
  }
}
```

## 十二、监控与日志

### 12.1 搜索性能监控

#### 12.1.1 性能指标
- **搜索响应时间**：平均搜索时间
- **搜索成功率**：搜索成功比例
- **索引使用率**：索引命中率
- **缓存命中率**：缓存命中率

#### 12.1.2 用户行为监控
- **搜索关键词统计**：热门搜索词
- **搜索频率统计**：用户搜索频率
- **搜索结果点击率**：结果点击率
- **搜索转化率**：搜索到查看的转化率

### 12.2 搜索日志管理

#### 12.2.1 日志内容
- **搜索请求日志**：搜索关键词、条件、时间
- **搜索结果日志**：结果数量、响应时间
- **搜索错误日志**：错误类型、错误信息
- **性能日志**：查询时间、索引使用情况

#### 12.2.2 日志分析
- **搜索趋势分析**：搜索量变化趋势
- **热门搜索分析**：最受欢迎的搜索词
- **性能瓶颈分析**：慢查询分析
- **用户行为分析**：搜索行为模式

## 十三、测试策略

### 13.1 功能测试

#### 13.1.1 搜索功能测试
- **关键词搜索测试**：各种关键词搜索
- **条件筛选测试**：各种筛选条件
- **高级搜索测试**：复杂搜索条件
- **相似搜索测试**：相似照片搜索

#### 13.1.2 界面测试
- **搜索界面测试**：界面响应和交互
- **结果展示测试**：结果展示和分页
- **搜索建议测试**：建议功能和准确性
- **搜索历史测试**：历史记录管理

### 13.2 性能测试

#### 13.2.1 搜索性能测试
- **响应时间测试**：搜索响应时间
- **并发搜索测试**：多用户同时搜索
- **大数据量测试**：大量照片搜索
- **索引性能测试**：索引创建和更新性能

#### 13.2.2 压力测试
- **高并发测试**：高并发搜索请求
- **长时间运行测试**：长时间连续搜索
- **内存使用测试**：搜索过程内存使用
- **数据库压力测试**：数据库查询压力

## 十四、总结

搜索检索模块是家庭照片整理系统的核心交互模块，通过整合丰富的元数据，为用户提供多维度、智能化的照片搜索功能。模块设计遵循简单易用的原则，在保证功能完整性的同时，确保搜索性能和用户体验。

**设计特点**：
- 搜索功能丰富，支持多种搜索方式
- 数据库索引优化，搜索性能优异
- 用户界面友好，操作简单直观
- 配置管理灵活，易于维护扩展
- 监控日志完善，便于问题排查

**适用场景**：
- 家庭单机使用，单用户，支持1-5万张照片搜索
- 支持照片管理、智能搜索、结果推荐等核心功能
- 提供良好的搜索体验和系统性能

通过遵循本设计文档，开发团队可以快速实现搜索检索模块的功能，为整个系统的开发奠定坚实的基础。