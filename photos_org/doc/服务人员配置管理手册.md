# 家庭单机版智能照片整理系统 - 服务人员配置管理手册

## 一、文档基础信息

| 项目名称 | 家庭单机版智能照片整理系统 | 文档类型 | 服务人员配置管理手册 |
| -------- | ------------------------- | -------- | ------------------- |
| 文档版本 | V1.0 | 文档状态 | ☑ 草稿 □ 评审中 □ 已确认 □ 已归档 |
| 编写人 | AI助手 | 编写日期 | 2025年1月19日 |
| 关联文档 | 《配置管理模块详细设计文档》《系统管理员配置管理手册》 | | |

## 二、配置管理概述

### 2.1 配置管理原则

本系统采用**两层次配置管理**：
- **用户配置**：通过Web界面配置，适合普通用户
- **服务人员配置**：通过直接编辑 `config.json` 文件配置，适合系统维护人员

### 2.2 配置文件位置

- **主配置文件**：`config.json`（项目根目录）
- **备份文件**：`config.json.backup`（自动生成）
- **默认配置**：`config.default.json`（系统默认值）

### 2.3 配置优先级

1. **环境变量**（最高优先级）
2. **config.json** 中的值
3. **代码默认值**（最低优先级）

## 三、完整 config.json 配置

```json
{
  "system": {
    "max_file_size": 52428800,
    "timeout": 10,
    "max_concurrent": 2,
    "temp_file_max_age": 24
  },
  "server": {
    "host": "127.0.0.1",
    "port": 8000,
    "debug": true
  },
  "database": {
    "path": "./data/photos.db"
  },
  "logging": {
    "level": "INFO",
    "file_path": "./logs/app.log",
    "max_size": "10MB",
    "backup_count": 5
  },
  "dashscope": {
    "api_key": "",
    "model": "qwen-vl-plus-latest",
    "available_models": [
      "qwen-vl-plus-latest",
      "qwen-vl-plus-2025-08-15",
      "qwen-vl-plus-2025-05-07",
      "qwen-vl-plus-2025-01-25"
    ],
    "timeout": 30,
    "max_retry_count": 3
  },
  "storage": {
    "base_path": "./photos_storage",
    "originals_path": "originals",
    "thumbnails_path": "thumbnails",
    "temp_path": "temp",
    "backups_path": "backups",
    "thumbnail_size": 300,
    "thumbnail_quality": 85
  },
  "analysis": {
    "duplicate_threshold": 5,
    "quality_threshold": 0,
    "concurrent": 2,
    "timeout": 30,
    "batch_size": 10
  },
  "ui": {
    "photos_per_page": 12,
    "similar_photos_limit": 8,
    "hot_tags_limit": 10,
    "hot_categories_limit": 10
  },
  "search": {
    "similarity_threshold": 0.8,
    "timeout": 5,
    "default_page_size": 20,
    "max_page_size": 100,
    "suggestion_limit": 10,
    "history_limit": 50
  },
  "similarity": {
    "first_layer_weights": {
      "perceptual_hash": 0.25,
      "objects": 0.15,
      "time": 0.15,
      "color_histogram": 0.15,
      "scene_type": 0.10,
      "location": 0.10,
      "description": 0.10,
      "emotion": 0.05,
      "activity": 0.05,
      "tags": 0.05,
      "camera": 0.05,
      "structural": 0.10
    },
    "first_layer_thresholds": {
      "perceptual_hash": 0.6,
      "color_histogram": 0.7,
      "structural": 0.8,
      "scene_type": 1.0,
      "objects": 0.5,
      "emotion": 0.6,
      "activity": 0.6,
      "description": 0.5,
      "tags": 0.5,
      "time": 0.8,
      "location": 0.9,
      "camera": 0.7,
      "combined": 0.55
    },
    "algorithms": {
      "primary_algorithm": "perceptual_hash",
      "fallback_algorithms": ["color_histogram", "structural"],
      "ai_enabled": true,
      "exif_enabled": true
    },
    "performance": {
      "batch_size": 100,
      "cache_enabled": true,
      "cache_ttl": 3600,
      "max_concurrent": 5
    }
  },
  "import": {
    "supported_formats": [".jpg", ".jpeg", ".png", ".tiff", ".webp", ".bmp", ".gif"],
    "max_upload_files": 50,
    "scan_batch_size": 100
  },
  "quality": {
    "weights": {
      "sharpness": 0.3,
      "brightness": 0.2,
      "contrast": 0.2,
      "color": 0.15,
      "composition": 0.15
    },
    "thresholds": {
      "excellent": 80,
      "good": 60,
      "fair": 40,
      "poor": 20
    }
  }
}
```

## 四、用户配置参数标识

### 4.1 用户配置参数列表

以下参数用户可以通过Web界面配置：

| 配置分类 | 参数路径 | 参数名 | 说明 |
|---------|----------|--------|------|
| **AI服务设置** | `dashscope.model` | 大模型选择 | 选择AI分析模型 |
| | `dashscope.api_key` | API密钥 | DashScope API密钥 |
| **存储设置** | `storage.base_path` | 照片存储目录 | 照片文件存储位置 |
| | `database.path` | 数据库文件位置 | 数据库文件存储位置 |
| | `storage.thumbnail_quality` | 缩略图质量 | 缩略图压缩质量 |
| | `storage.thumbnail_size` | 缩略图尺寸 | 缩略图像素大小 |
| | `system.max_file_size` | 文件大小限制 | 单张照片最大大小 |
| **界面设置** | `ui.photos_per_page` | 每页显示照片数 | 照片列表每页数量 |
| | `ui.similar_photos_limit` | 相似照片显示数量 | 查看相似照片时显示数量 |
| | `ui.hot_tags_limit` | 热门标签显示数量 | 侧边栏热门标签数量 |
| | `ui.hot_categories_limit` | 热门分类显示数量 | 侧边栏热门分类数量 |
| **搜索设置** | `search.similarity_threshold` | 相似度阈值 | 相似照片搜索阈值 |
| | `analysis.duplicate_threshold` | 重复检测阈值 | 重复照片检测阈值 |

### 4.2 用户配置特点

- **总计13个参数**：用户可配置的参数数量
- **Web界面配置**：通过 `/settings` 页面进行配置
- **实时生效**：大部分配置修改后立即生效
- **环境变量优先**：API密钥优先使用环境变量

## 五、配置参数详细说明

### 5.1 系统基础配置 (system)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `max_file_size` | int | 52428800 | 25MB-200MB | 单文件最大大小（字节） | ✅ | 50MB |
| `timeout` | int | 10 | 1-300 | 请求超时时间（秒） | ❌ | 10-30 |
| `max_concurrent` | int | 2 | 1-10 | 最大并发数 | ❌ | 2-5 |
| `temp_file_max_age` | int | 24 | 1-168 | 临时文件最大年龄（小时） | ❌ | 24-48 |

### 5.2 服务器配置 (server)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `host` | str | "127.0.0.1" | - | 服务器绑定地址 | ❌ | 127.0.0.1 |
| `port` | int | 8000 | 1000-65535 | 服务器端口 | ❌ | 8000 |
| `debug` | bool | true | true/false | 调试模式 | ❌ | false（生产环境） |

### 5.3 数据库配置 (database)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `path` | str | "./data/photos.db" | - | 数据库文件路径 | ✅ | 相对路径 |

### 5.4 日志配置 (logging)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `level` | str | "INFO" | DEBUG/INFO/WARNING/ERROR | 日志级别 | ❌ | INFO |
| `file_path` | str | "./logs/app.log" | - | 日志文件路径 | ❌ | 相对路径 |
| `max_size` | str | "10MB" | 1MB-100MB | 日志文件最大大小 | ❌ | 10MB |
| `backup_count` | int | 5 | 1-20 | 日志备份数量 | ❌ | 5-10 |

### 5.5 DashScope配置 (dashscope)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `api_key` | str | "" | - | API密钥（环境变量优先） | ✅ | 环境变量 |
| `model` | str | "qwen-vl-plus-latest" | 动态配置 | 当前使用的模型 | ✅ | qwen-vl-plus-latest |
| `available_models` | array | ["qwen-vl-plus-latest", "qwen-vl-plus-2025-08-15"] | - | 用户可选择的模型列表 | ❌ | 根据需求配置 |
| `timeout` | int | 30 | 5-300 | API请求超时时间（秒） | ❌ | 30-60 |
| `max_retry_count` | int | 3 | 1-10 | 最大重试次数 | ❌ | 3-5 |

#### 5.5.1 模型管理说明

**available_models 配置：**
- 用户配置界面只显示此列表中的模型
- 服务人员可以添加/删除模型ID
- 支持所有DashScope API兼容的模型

**常用模型ID：**
- `qwen-vl-plus-latest` - 最新版本（推荐）
- `qwen-vl-plus-2025-08-15` - 2025年8月版本
- `qwen-vl-plus-2025-05-07` - 2025年5月版本
- `qwen-vl-plus-2025-01-25` - 2025年1月版本

**添加新模型：**
```json
{
  "dashscope": {
    "available_models": [
      "qwen-vl-plus-latest",
      "qwen-vl-plus-2025-08-15",
      "qwen-vl-plus-2025-05-07",
      "qwen-vl-plus-2025-01-25",
      "qwen-vl-plus-2025-12-01"  // 新添加的模型
    ]
  }
}
```

### 5.6 存储配置 (storage)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `base_path` | str | "./photos_storage" | - | 存储根目录 | ✅ | 相对路径 |
| `originals_path` | str | "originals" | - | 原图存储路径 | ❌ | 固定值 |
| `thumbnails_path` | str | "thumbnails" | - | 缩略图存储路径 | ❌ | 固定值 |
| `temp_path` | str | "temp" | - | 临时文件存储路径 | ❌ | 固定值 |
| `backups_path` | str | "backups" | - | 备份文件存储路径 | ❌ | 固定值 |
| `thumbnail_size` | int | 300 | 100-1000 | 缩略图尺寸（像素） | ✅ | 300-500 |
| `thumbnail_quality` | int | 85 | 1-100 | 缩略图质量（%） | ✅ | 80-90 |

### 5.7 分析配置 (analysis)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `duplicate_threshold` | int | 5 | 1-20 | 重复检测阈值 | ✅ | 5-10 |
| `quality_threshold` | int | 0 | 0-100 | 质量评估阈值 | ❌ | 0 |
| `concurrent` | int | 2 | 1-5 | 分析并发数 | ❌ | 2-4 |
| `timeout` | int | 30 | 5-300 | 分析超时时间（秒） | ❌ | 30-60 |
| `batch_size` | int | 10 | 1-50 | 批量分析大小 | ❌ | 10-20 |

### 5.8 用户界面配置 (ui)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `photos_per_page` | int | 12 | 6-50 | 每页显示照片数量 | ✅ | 12-20 |
| `similar_photos_limit` | int | 8 | 4-20 | 相似照片显示数量 | ✅ | 8-12 |
| `hot_tags_limit` | int | 10 | 5-30 | 热门标签显示数量 | ✅ | 10-15 |
| `hot_categories_limit` | int | 10 | 5-30 | 热门分类显示数量 | ✅ | 10-15 |

### 5.9 搜索配置 (search)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `similarity_threshold` | float | 0.8 | 0.0-1.0 | 相似度阈值 | ✅ | 0.7-0.9 |
| `timeout` | int | 5 | 1-60 | 搜索超时时间（秒） | ❌ | 5-10 |
| `default_page_size` | int | 20 | 10-100 | 默认分页大小 | ❌ | 20-50 |
| `max_page_size` | int | 100 | 50-500 | 最大分页大小 | ❌ | 100-200 |
| `suggestion_limit` | int | 10 | 5-50 | 搜索建议数量 | ❌ | 10-20 |
| `history_limit` | int | 50 | 10-200 | 搜索历史数量 | ❌ | 50-100 |

### 5.10 相似度检测配置 (similarity)

#### 5.10.1 第一层权重配置 (first_layer_weights)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `perceptual_hash` | float | 0.25 | 0.0-1.0 | 感知哈希权重 | ❌ | 0.2-0.3 |
| `objects` | float | 0.15 | 0.0-1.0 | AI对象权重 | ❌ | 0.1-0.2 |
| `time` | float | 0.15 | 0.0-1.0 | 时间相似度权重 | ❌ | 0.1-0.2 |
| `color_histogram` | float | 0.15 | 0.0-1.0 | 颜色直方图权重 | ❌ | 0.1-0.2 |
| `scene_type` | float | 0.10 | 0.0-1.0 | 场景类型权重 | ❌ | 0.05-0.15 |
| `location` | float | 0.10 | 0.0-1.0 | 位置相似度权重 | ❌ | 0.05-0.15 |
| `description` | float | 0.10 | 0.0-1.0 | 描述相似度权重 | ❌ | 0.05-0.15 |
| `emotion` | float | 0.05 | 0.0-1.0 | 情感相似度权重 | ❌ | 0.02-0.08 |
| `activity` | float | 0.05 | 0.0-1.0 | 活动相似度权重 | ❌ | 0.02-0.08 |
| `tags` | float | 0.05 | 0.0-1.0 | 标签相似度权重 | ❌ | 0.02-0.08 |
| `camera` | float | 0.05 | 0.0-1.0 | 相机参数权重 | ❌ | 0.02-0.08 |
| `structural` | float | 0.10 | 0.0-1.0 | 结构相似度权重 | ❌ | 0.05-0.15 |

#### 5.10.2 第一层阈值配置 (first_layer_thresholds)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `perceptual_hash` | float | 0.6 | 0.0-1.0 | 感知哈希阈值 | ❌ | 0.5-0.7 |
| `color_histogram` | float | 0.7 | 0.0-1.0 | 颜色直方图阈值 | ❌ | 0.6-0.8 |
| `structural` | float | 0.8 | 0.0-1.0 | 结构相似度阈值 | ❌ | 0.7-0.9 |
| `scene_type` | float | 1.0 | 0.0-1.0 | 场景类型阈值 | ❌ | 0.8-1.0 |
| `objects` | float | 0.5 | 0.0-1.0 | 对象相似度阈值 | ❌ | 0.4-0.6 |
| `emotion` | float | 0.6 | 0.0-1.0 | 情感相似度阈值 | ❌ | 0.5-0.7 |
| `activity` | float | 0.6 | 0.0-1.0 | 活动相似度阈值 | ❌ | 0.5-0.7 |
| `description` | float | 0.5 | 0.0-1.0 | 描述相似度阈值 | ❌ | 0.4-0.6 |
| `tags` | float | 0.5 | 0.0-1.0 | 标签相似度阈值 | ❌ | 0.4-0.6 |
| `time` | float | 0.8 | 0.0-1.0 | 时间相似度阈值 | ❌ | 0.7-0.9 |
| `location` | float | 0.9 | 0.0-1.0 | 位置相似度阈值 | ❌ | 0.8-1.0 |
| `camera` | float | 0.7 | 0.0-1.0 | 相机参数阈值 | ❌ | 0.6-0.8 |
| `combined` | float | 0.55 | 0.0-1.0 | 综合相似度阈值 | ❌ | 0.5-0.7 |

### 5.11 导入配置 (import)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `supported_formats` | array | [".jpg", ".jpeg", ".png", ".tiff", ".webp", ".bmp", ".gif"] | - | 支持的文件格式 | ❌ | 固定值 |
| `max_upload_files` | int | 50 | 10-200 | 单次最大上传文件数 | ❌ | 50-100 |
| `scan_batch_size` | int | 100 | 50-500 | 文件夹扫描批次大小 | ❌ | 100-200 |

### 5.12 质量评估配置 (quality)

| 参数名 | 类型 | 默认值 | 范围 | 说明 | 用户配置 | 推荐值 |
|--------|------|--------|------|------|----------|--------|
| `weights.sharpness` | float | 0.3 | 0.0-1.0 | 清晰度权重 | ❌ | 0.2-0.4 |
| `weights.brightness` | float | 0.2 | 0.0-1.0 | 亮度权重 | ❌ | 0.15-0.25 |
| `weights.contrast` | float | 0.2 | 0.0-1.0 | 对比度权重 | ❌ | 0.15-0.25 |
| `weights.color` | float | 0.15 | 0.0-1.0 | 色彩权重 | ❌ | 0.1-0.2 |
| `weights.composition` | float | 0.15 | 0.0-1.0 | 构图权重 | ❌ | 0.1-0.2 |
| `thresholds.excellent` | int | 80 | 70-90 | 优秀质量阈值 | ❌ | 80-85 |
| `thresholds.good` | int | 60 | 50-70 | 良好质量阈值 | ❌ | 60-65 |
| `thresholds.fair` | int | 40 | 30-50 | 一般质量阈值 | ❌ | 40-45 |
| `thresholds.poor` | int | 20 | 10-30 | 较差质量阈值 | ❌ | 20-25 |

## 六、配置方法说明

### 6.1 直接编辑配置文件

**步骤：**
1. 停止系统服务
2. 备份当前配置文件：`cp config.json config.json.backup`
3. 使用文本编辑器打开 `config.json`
4. 修改相应参数值
5. 保存文件
6. 启动系统服务

**注意事项：**
- 确保JSON格式正确，避免语法错误
- 数值类型参数不要加引号
- 字符串类型参数必须加引号
- 修改后建议重启系统确保生效

### 6.2 环境变量配置

**设置方法：**
```bash
# Windows (PowerShell)
$env:DASHSCOPE_API_KEY="your_api_key_here"
$env:MAX_FILE_SIZE="104857600"

# Linux/Mac
export DASHSCOPE_API_KEY="your_api_key_here"
export MAX_FILE_SIZE="104857600"
```

**支持的环境变量：**
- `DASHSCOPE_API_KEY` - DashScope API密钥
- `MAX_FILE_SIZE` - 文件大小限制
- `STORAGE_BASE_PATH` - 存储根目录
- `THUMBNAIL_SIZE` - 缩略图尺寸
- `THUMBNAIL_QUALITY` - 缩略图质量
- `DUPLICATE_THRESHOLD` - 重复检测阈值
- `QUALITY_THRESHOLD` - 质量评估阈值
- `ANALYSIS_CONCURRENT` - 分析并发数
- `ANALYSIS_TIMEOUT` - 分析超时时间

### 6.3 配置验证

**验证方法：**
1. 检查JSON格式：使用在线JSON验证工具
2. 检查参数范围：确保数值在有效范围内
3. 检查文件路径：确保路径存在且可访问
4. 启动测试：修改后启动系统检查是否正常

## 七、系统改造需求

### 7.1 后端改造

#### 7.1.1 配置加载改造
- **文件**：`app/core/config.py`
- **改造内容**：
  - 添加 `UIConfig` 和 `SearchConfig` 配置类
  - 实现 `get_user_config()` 和 `update_user_config()` 方法
  - 实现环境变量优先级处理

#### 7.1.2 服务层改造
- **文件**：`app/services/dashscope_service.py`
- **改造内容**：使用配置中的 `model` 参数替换硬编码

- **文件**：`app/services/duplicate_detection_service.py`
- **改造内容**：使用配置中的 `duplicate_threshold` 替换硬编码

- **文件**：`app/api/search.py`
- **改造内容**：使用配置中的 `similarity_threshold` 替换硬编码

#### 7.1.3 API接口改造
- **文件**：`app/api/config.py`（新建）
- **改造内容**：实现用户配置管理API

### 7.2 前端改造

#### 7.2.1 配置加载改造
- **文件**：`static/js/app-data.js`
- **改造内容**：使用配置参数替换硬编码常量

- **文件**：`static/js/app-photos.js`
- **改造内容**：使用配置参数替换硬编码常量

#### 7.2.2 配置管理界面
- **文件**：`templates/settings.html`（新建）
- **改造内容**：用户配置管理页面

- **文件**：`static/js/user-config-manager.js`（新建）
- **改造内容**：配置管理前端逻辑

### 7.3 配置文件改造

#### 7.3.1 主配置文件
- **文件**：`config.json`
- **改造内容**：添加 `ui` 和 `search` 配置节

#### 7.3.2 默认配置文件
- **文件**：`config.default.json`（新建）
- **改造内容**：提供默认配置模板

## 八、配置优化建议

### 8.1 性能优化配置

**高并发场景：**
```json
{
  "system": {
    "max_concurrent": 5,
    "timeout": 30
  },
  "analysis": {
    "concurrent": 4,
    "batch_size": 20
  },
  "similarity": {
    "performance": {
      "max_concurrent": 8,
      "batch_size": 200
    }
  }
}
```

**低资源场景：**
```json
{
  "system": {
    "max_concurrent": 1,
    "timeout": 60
  },
  "analysis": {
    "concurrent": 1,
    "batch_size": 5
  },
  "similarity": {
    "performance": {
      "max_concurrent": 2,
      "batch_size": 50
    }
  }
}
```

### 8.2 相似度检测优化

**高精度模式：**
```json
{
  "similarity": {
    "first_layer_thresholds": {
      "combined": 0.7,
      "perceptual_hash": 0.7,
      "objects": 0.6
    }
  }
}
```

**快速模式：**
```json
{
  "similarity": {
    "first_layer_thresholds": {
      "combined": 0.5,
      "perceptual_hash": 0.5,
      "objects": 0.4
    }
  }
}
```

### 8.3 存储优化配置

**大容量存储：**
```json
{
  "storage": {
    "thumbnail_size": 500,
    "thumbnail_quality": 90
  },
  "system": {
    "max_file_size": 209715200
  }
}
```

**存储空间紧张：**
```json
{
  "storage": {
    "thumbnail_size": 200,
    "thumbnail_quality": 70
  },
  "system": {
    "max_file_size": 52428800
  }
}
```

## 九、故障排除

### 9.1 常见配置错误

**JSON格式错误：**
- 症状：系统启动失败，日志显示JSON解析错误
- 解决：检查JSON语法，确保括号匹配

**参数范围错误：**
- 症状：系统启动正常但功能异常
- 解决：检查参数值是否在有效范围内

**路径错误：**
- 症状：文件操作失败
- 解决：检查路径是否存在且可访问

**环境变量冲突：**
- 症状：配置不生效
- 解决：检查环境变量是否与配置文件冲突

### 9.2 配置恢复

**自动备份恢复：**
1. 停止系统服务
2. 恢复备份文件：`cp config.json.backup config.json`
3. 启动系统服务

**手动恢复：**
1. 停止系统服务
2. 删除损坏的配置文件：`rm config.json`
3. 复制默认配置：`cp config.default.json config.json`
4. 根据实际情况修改配置
5. 启动系统服务

### 9.3 配置监控

**日志监控：**
- 查看配置加载日志：`tail -f logs/app.log | grep "config"`
- 查看配置错误日志：`tail -f logs/app.log | grep "error"`

**性能监控：**
- 监控系统资源使用情况
- 监控配置参数对性能的影响
- 根据监控结果调整配置

## 十、最佳实践

### 10.1 配置管理原则

**配置分离：**
- 用户配置与系统配置分离
- 开发配置与生产配置分离
- 敏感配置与普通配置分离

**配置版本控制：**
- 配置文件纳入版本控制
- 配置变更记录变更原因
- 重要配置变更前进行测试

**配置备份：**
- 定期备份配置文件
- 配置变更前自动备份
- 保留多个历史版本

### 10.2 配置优化策略

**性能优化：**
- 根据硬件资源调整并发参数
- 根据数据量调整批次大小
- 根据使用场景调整超时时间

**存储优化：**
- 根据存储空间调整缩略图参数
- 根据文件大小调整上传限制
- 根据使用频率调整缓存参数

**安全优化：**
- 敏感配置使用环境变量
- 定期更新API密钥
- 限制配置文件访问权限

### 10.3 配置测试

**配置验证：**
- 配置修改后立即验证
- 使用测试数据验证配置
- 监控配置对系统的影响

**配置回滚：**
- 配置问题及时回滚
- 保留配置变更历史
- 建立配置回滚流程

## 十一、附录

### 11.1 配置文件模板

**config.default.json 模板：**
```json
{
  "system": {
    "max_file_size": 52428800,
    "timeout": 10,
    "max_concurrent": 2,
    "temp_file_max_age": 24
  },
  "server": {
    "host": "127.0.0.1",
    "port": 8000,
    "debug": false
  },
  "database": {
    "path": "./data/photos.db"
  },
  "logging": {
    "level": "INFO",
    "file_path": "./logs/app.log",
    "max_size": "10MB",
    "backup_count": 5
  },
  "dashscope": {
    "api_key": "",
    "model": "qwen-vl-plus",
    "timeout": 30,
    "max_retry_count": 3
  },
  "storage": {
    "base_path": "./photos_storage",
    "originals_path": "originals",
    "thumbnails_path": "thumbnails",
    "temp_path": "temp",
    "backups_path": "backups",
    "thumbnail_size": 300,
    "thumbnail_quality": 85
  },
  "analysis": {
    "duplicate_threshold": 5,
    "quality_threshold": 0,
    "concurrent": 2,
    "timeout": 30,
    "batch_size": 10
  },
  "ui": {
    "photos_per_page": 12,
    "similar_photos_limit": 8,
    "hot_tags_limit": 10,
    "hot_categories_limit": 10
  },
  "search": {
    "similarity_threshold": 0.8,
    "timeout": 5,
    "default_page_size": 20,
    "max_page_size": 100,
    "suggestion_limit": 10,
    "history_limit": 50
  },
  "similarity": {
    "first_layer_weights": {
      "perceptual_hash": 0.25,
      "objects": 0.15,
      "time": 0.15,
      "color_histogram": 0.15,
      "scene_type": 0.10,
      "location": 0.10,
      "description": 0.10,
      "emotion": 0.05,
      "activity": 0.05,
      "tags": 0.05,
      "camera": 0.05,
      "structural": 0.10
    },
    "first_layer_thresholds": {
      "perceptual_hash": 0.6,
      "color_histogram": 0.7,
      "structural": 0.8,
      "scene_type": 1.0,
      "objects": 0.5,
      "emotion": 0.6,
      "activity": 0.6,
      "description": 0.5,
      "tags": 0.5,
      "time": 0.8,
      "location": 0.9,
      "camera": 0.7,
      "combined": 0.55
    },
    "algorithms": {
      "primary_algorithm": "perceptual_hash",
      "fallback_algorithms": ["color_histogram", "structural"],
      "ai_enabled": true,
      "exif_enabled": true
    },
    "performance": {
      "batch_size": 100,
      "cache_enabled": true,
      "cache_ttl": 3600,
      "max_concurrent": 5
    }
  },
  "import": {
    "supported_formats": [".jpg", ".jpeg", ".png", ".tiff", ".webp", ".bmp", ".gif"],
    "max_upload_files": 50,
    "scan_batch_size": 100
  },
  "quality": {
    "weights": {
      "sharpness": 0.3,
      "brightness": 0.2,
      "contrast": 0.2,
      "color": 0.15,
      "composition": 0.15
    },
    "thresholds": {
      "excellent": 80,
      "good": 60,
      "fair": 40,
      "poor": 20
    }
  }
}
```

### 11.2 环境变量列表

**支持的环境变量：**
| 环境变量名 | 对应配置项 | 说明 | 示例 |
|------------|------------|------|------|
| `DASHSCOPE_API_KEY` | `dashscope.api_key` | DashScope API密钥 | `sk-xxx` |
| `DASHSCOPE_MODEL` | `dashscope.model` | 当前使用的模型 | `qwen-vl-plus-latest` |
| `MAX_FILE_SIZE` | `system.max_file_size` | 文件大小限制 | `52428800` |
| `STORAGE_BASE_PATH` | `storage.base_path` | 存储根目录 | `./photos_storage` |
| `THUMBNAIL_SIZE` | `storage.thumbnail_size` | 缩略图尺寸 | `300` |
| `THUMBNAIL_QUALITY` | `storage.thumbnail_quality` | 缩略图质量 | `85` |
| `DUPLICATE_THRESHOLD` | `analysis.duplicate_threshold` | 重复检测阈值 | `5` |
| `QUALITY_THRESHOLD` | `analysis.quality_threshold` | 质量评估阈值 | `0` |
| `ANALYSIS_CONCURRENT` | `analysis.concurrent` | 分析并发数 | `2` |
| `ANALYSIS_TIMEOUT` | `analysis.timeout` | 分析超时时间 | `30` |
| `SIMILARITY_THRESHOLD` | `search.similarity_threshold` | 相似度阈值 | `0.8` |
| `PHOTOS_PER_PAGE` | `ui.photos_per_page` | 每页显示照片数 | `12` |
| `SIMILAR_PHOTOS_LIMIT` | `ui.similar_photos_limit` | 相似照片显示数量 | `8` |

## 十二、总结

### 12.1 文档要点

本手册详细介绍了家庭单机版智能照片整理系统的配置管理，包括：

1. **完整配置结构**：涵盖系统、服务器、数据库、AI服务、存储、分析、界面、搜索、相似度检测等各个方面
2. **用户配置标识**：明确标识了13个用户可配置参数
3. **详细参数说明**：每个参数都有类型、默认值、范围、说明、推荐值等详细信息
4. **配置方法**：提供了直接编辑、环境变量、配置验证等多种配置方法
5. **系统改造需求**：详细说明了后端、前端、配置文件的改造需求
6. **最佳实践**：提供了配置管理、优化、测试的最佳实践
7. **实用工具**：提供了配置检查、备份、监控等实用脚本

### 12.2 使用建议

**服务人员使用建议：**
- 配置修改前先备份
- 重要配置修改前先测试
- 定期检查配置文件完整性
- 使用提供的脚本工具进行配置管理

**系统维护建议：**
- 建立配置变更记录
- 定期更新配置文档
- 监控配置对系统性能的影响
- 建立配置回滚机制

### 12.3 后续更新

本手册将根据系统功能更新和用户反馈持续更新，确保配置管理的准确性和实用性。

---

**文档版本**: V1.0  
**最后更新**: 2025年1月19日  
**维护人员**: AI助手